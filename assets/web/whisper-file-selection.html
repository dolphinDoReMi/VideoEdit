<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
  <script> window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
    /* Tailwind: keep your theme, add a safelist for status dots used by JS */
        tailwind.config = {
      safelist: [
        'bg-yellow-500','bg-blue-500','bg-purple-500','bg-green-500','bg-gray-500',
        'bg-green-500/20','bg-blue-500/20','text-green-300','text-blue-300'
      ],
            theme: {
                extend: {
                    colors: {
            dark: { 900:'#0a0a0a', 800:'#1a1a1a', 700:'#2a2a2a', 600:'#3a3a3a' }
                    }
                }
            }
        }
    </script>
  <style>
    ::-webkit-scrollbar { display: none; }
    * { font-family: 'Inter', sans-serif; }
    @media (prefers-reduced-motion: reduce) { .animate-pulse { animation: none !important; } }
  </style>
</head>
<body class="bg-dark-900 text-white overflow-x-hidden">

<!-- Status Bar -->
<div id="status-bar" class="flex justify-between items-center px-4 py-2 bg-dark-800 text-xs text-gray-300">
    <div class="flex items-center space-x-1">
        <div class="w-1 h-1 bg-white rounded-full"></div>
        <div class="w-1 h-1 bg-white rounded-full"></div>
        <div class="w-1 h-1 bg-gray-600 rounded-full"></div>
        <span class="ml-2">Verizon</span>
    </div>
    <div class="font-medium">9:41</div>
    <div class="flex items-center space-x-1">
        <i class="fa-solid fa-signal text-xs"></i>
        <i class="fa-solid fa-wifi text-xs"></i>
        <div class="w-6 h-3 border border-white rounded-sm">
            <div class="w-4 h-2 bg-white rounded-sm m-0.5"></div>
        </div>
    </div>
</div>

<!-- App Header -->
<div id="app-header" class="flex items-center justify-between px-6 py-4 bg-dark-800 border-b border-dark-600">
    <div class="flex items-center space-x-3">
    <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
      <i class="fa-solid fa-play text-white text-sm"></i>
    </div>
        <div>
      <h1 class="text-lg font-semibold text-white">DeepDive</h1>
      <p class="text-xs text-gray-400">AI Video Analysis</p>
        </div>
    </div>
    <div class="flex items-center space-x-3">
        <button class="w-8 h-8 bg-dark-600 rounded-full flex items-center justify-center">
      <i class="fa-solid fa-bell text-gray-300 text-sm"></i>
    </button>
        <button class="w-8 h-8 bg-dark-600 rounded-full flex items-center justify-center">
      <i class="fa-solid fa-user text-gray-300 text-sm"></i>
        </button>
    </div>
</div>

<!-- Main Dashboard Section -->
<div id="main-dashboard" class="px-6 py-8">
  <!-- Status Card -->
  <div id="status-card" class="bg-gradient-to-r from-dark-700 to-dark-600 rounded-2xl p-6 mb-6 border border-dark-600">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold text-white">Project Status</h2>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        <span class="text-sm text-green-400 font-medium">Ready</span>
            </div>
            </div>
    <p class="text-gray-300 mb-4">Whisper Step 1: File Selection → Processing → Results</p>
    <div class="flex items-center space-x-4">
      <div class="flex items-center space-x-2">
        <i class="fa-solid fa-clock text-purple-400"></i>
        <span class="text-sm text-gray-400">File Selection Ready</span>
            </div>
      <div class="flex items-center space-x-2">
        <i class="fa-solid fa-chart-line text-blue-400"></i>
        <span class="text-sm text-gray-400">Batch Processing Support</span>
        </div>
            </div>
        </div>
        
  <!-- Quick Stats (unchanged visuals) -->
  <div id="quick-stats" class="grid grid-cols-3 gap-3 mb-8">
    <div class="bg-dark-700 rounded-xl p-4 border border-dark-600">
            <div class="text-center">
        <div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center mx-auto mb-2">
          <i class="fa-solid fa-video text-purple-400"></i>
            </div>
        <p class="text-2xl font-bold text-white" id="stat-videos">47</p>
        <p class="text-xs text-gray-400">Videos</p>
      </div>
    </div>
    <div class="bg-dark-700 rounded-xl p-4 border border-dark-600">
            <div class="text-center">
        <div class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center mx-auto mb-2">
          <i class="fa-solid fa-brain text-blue-400"></i>
            </div>
        <p class="text-2xl font-bold text-white" id="stat-insights">23</p>
        <p class="text-xs text-gray-400">Insights</p>
            </div>
            </div>
    <div class="bg-dark-700 rounded-xl p-4 border border-dark-600">
            <div class="text-center">
        <div class="w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center mx-auto mb-2">
          <i class="fa-solid fa-star text-green-400"></i>
        </div>
        <p class="text-2xl font-bold text-white">8.9</p>
        <p class="text-xs text-gray-400">Avg Score</p>
            </div>
        </div>
    </div>
</div>

<!-- Whisper: Step 1 Control Panel -->
<div id="main-actions" class="px-6 mb-8">
  <div class="bg-dark-700 rounded-2xl p-6 border border-dark-600">
    <h3 class="text-lg font-semibold text-white mb-6">Whisper — Step 1: File Selection</h3>

    <!-- File Selection Section -->
    <div class="mb-4">
      <button id="select-files-btn"
              class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-semibold py-4 px-6 rounded-xl flex items-center justify-center space-x-3 transition-all duration-200 mb-4">
        <i class="fa-solid fa-folder-open text-xl"></i>
        <span class="text-lg">Select Video Files</span>
      </button>
      
      <!-- Preset Selection -->
      <div class="bg-dark-600 rounded-xl px-4 py-3 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <i class="fa-solid fa-sliders text-yellow-300"></i>
          <span class="text-sm text-gray-300">Processing Preset</span>
        </div>
        <div class="flex items-center space-x-2">
          <button id="preset-single" class="text-xs px-3 py-1 rounded-lg bg-purple-600 text-white font-medium">Single</button>
          <button id="preset-accuracy" class="text-xs px-3 py-1 rounded-lg bg-dark-700 border border-dark-600 text-gray-300">Accuracy</button>
        </div>
      </div>
    </div>
                
    <!-- Selected Files Summary -->
    <div id="selected-files-summary" class="bg-dark-800 rounded-xl p-3 border border-dark-600 mb-4 text-xs text-gray-300" style="display: none;">
      <div class="flex justify-between items-center mb-2">
        <span class="text-gray-400">Selected Files:</span>
        <span id="file-count" class="text-purple-300 font-medium">0</span>
      </div>
      <div id="files-list" class="space-y-1"></div>
      <div class="mt-2 pt-2 border-t border-dark-600">
        <div><span class="text-gray-400">Preset:</span> <span id="sel-preset">Single</span></div>
        <div><span class="text-gray-400">Model:</span> <span id="sel-model" class="break-all">ggml-small.en.bin (Default)</span></div>
      </div>
    </div>

    <!-- Process Button -->
    <button id="run-whisper-btn"
            class="w-full bg-dark-600 text-gray-400 font-semibold py-4 px-6 rounded-xl mb-4 flex items-center justify-center space-x-3 cursor-not-allowed opacity-60"
            disabled>
      <i class="fa-solid fa-play text-xl"></i>
      <span class="text-lg">Process Selected Files</span>
    </button>

    <!-- Status Information -->
    <div id="analysis-status" class="bg-dark-800 rounded-xl p-4 border border-dark-600"
         role="status" aria-live="polite" aria-busy="false">
      <div class="flex items-center space-x-3">
        <div class="w-3 h-3 bg-gray-500 rounded-full"></div>
                    <div>
          <p class="text-sm font-medium text-white">File Selection Status</p>
          <p class="text-xs text-gray-400">Ready — Select video files to process</p>
                    </div>
                </div>
        </div>
            </div>
        </div>
        
<!-- Runs / Sidecars -->
<div id="recent-projects" class="px-6 mb-8">
        <div class="flex items-center justify-between mb-4">
    <h3 class="text-lg font-semibold text-white">Whisper Runs</h3>
            <div class="flex items-center space-x-2">
      <button id="refresh-runs" class="text-purple-400 text-sm font-medium">Refresh</button>
    </div>
  </div>

  <div id="runs-list" class="space-y-3">
    <!-- dynamically populated -->
    <div class="text-sm text-gray-500">No runs yet.</div>
            </div>
        </div>
        
<!-- Staging — Select & Inspect (Step 0, UI-only) -->
<div id="staging" class="px-6 py-4">
  <div class="flex items-center justify-between mb-3">
    <h3 class="text-sm font-semibold text-white">Staging — Select & Inspect (Local + Cloud)</h3>
    <div class="flex items-center gap-2">
      <button id="check-perms-btn" class="hidden md:inline bg-dark-700 border border-dark-600 text-gray-300 text-xs px-3 py-1.5 rounded-lg">Check Perms</button>
      <button id="refresh-staging-btn" class="bg-dark-700 border border-dark-600 text-gray-300 text-xs px-3 py-1.5 rounded-lg">Refresh</button>
      <button id="add-folder-btn" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white text-xs px-3 py-1.5 rounded-lg">Add Folder</button>
    </div>
  </div>

  <!-- Controls -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
    <!-- Discovery controls -->
        <div class="bg-dark-700 rounded-xl p-4 border border-dark-600">
      <div class="flex items-center justify-between mb-3">
        <span class="text-white text-sm font-medium">Discovery</span>
        <label class="inline-flex items-center gap-2 text-xs">
          <input id="recursive-toggle" type="checkbox" class="accent-purple-500" checked>
          <span class="text-gray-300">Recursive</span>
        </label>
                    </div>
      <div class="grid grid-cols-2 gap-2 text-xs">
        <label class="flex items-center gap-2"><input type="checkbox" class="ext-filter accent-purple-500" value="mp4" checked><span>.mp4</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="ext-filter accent-purple-500" value="mov" checked><span>.mov</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="ext-filter accent-purple-500" value="mkv" checked><span>.mkv</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="ext-filter accent-purple-500" value="webm" checked><span>.webm</span></label>
                    </div>
      <div class="mt-3 text-xs">
        <label class="block text-gray-300 mb-1">Min duration (seconds)</label>
        <input id="min-duration" type="number" min="0" value="0"
               class="w-full bg-dark-800 border border-dark-600 rounded-lg px-3 py-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                </div>
      <div class="mt-3 text-xs">
        <label class="inline-flex items-center gap-2">
          <input id="local-first-toggle" type="checkbox" class="accent-purple-500" checked disabled>
          <span class="text-gray-400">Prioritize local storage (always on)</span>
        </label>
            </div>
        </div>
        
    <!-- Tracked folders -->
        <div class="bg-dark-700 rounded-xl p-4 border border-dark-600">
            <div class="flex items-center justify-between mb-3">
        <span class="text-white text-sm font-medium">Tracked Folders</span>
        <span id="folder-count" class="text-xs text-gray-400">0 folders</span>
                    </div>
      <div id="folder-list" class="space-y-2 text-xs">
        <div class="text-gray-500">No folders yet. Click <span class="text-purple-400">Add Folder</span> to pick a local/cloud directory.</div>
                    </div>
                </div>
            </div>
            
  <!-- Files table -->
  <div class="bg-dark-700 rounded-xl border border-dark-600">
    <div class="flex items-center justify-between px-4 py-2">
      <div class="text-xs text-gray-300">
        <span id="file-count">0</span> items • <span id="local-count">0</span> local • <span id="cloud-count">0</span> cloud
                    </div>
      <div id="selection-summary" class="text-xs text-gray-300">Selected 0 • 0.0 MB • ~0:00</div>
    </div>
    <div class="overflow-auto max-h-[24rem]">
      <table class="w-full text-left text-xs">
        <thead class="bg-dark-800 sticky top-0">
          <tr>
            <th class="px-4 py-2 w-10"><input id="toggle-all" type="checkbox" class="accent-purple-500"></th>
            <th class="px-4 py-2">Name</th>
            <th class="px-4 py-2">Provider</th>
            <th class="px-4 py-2">Duration</th>
            <th class="px-4 py-2">Size</th>
            <th class="px-4 py-2">URI</th>
            <th class="px-4 py-2 w-10"></th>
          </tr>
        </thead>
        <tbody id="staging-rows"></tbody>
      </table>
    </div>
                    </div>
                </div>
                
<div id="analysis-tools" class="px-6 mb-8">
  <h3 class="text-lg font-semibold text-white mb-4">Analysis Tools</h3>
                <div class="grid grid-cols-2 gap-3">
    <div class="bg-dark-700 rounded-xl p-4 border border-dark-600">
      <div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center mb-3">
        <i class="fa-solid fa-waveform-lines text-purple-400"></i>
                    </div>
      <h4 class="text-white font-medium mb-1">Audio Analysis</h4>
      <p class="text-gray-400 text-xs">Analyze speech patterns and audio content</p>
                    </div>
    <div class="bg-dark-700 rounded-xl p-4 border border-dark-600">
      <div class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center mb-3">
        <i class="fa-solid fa-eye text-blue-400"></i>
                </div>
      <h4 class="text-white font-medium mb-1">Visual Recognition</h4>
      <p class="text-gray-400 text-xs">Identify objects, scenes, and activities</p>
            </div>
    <div class="bg-dark-700 rounded-xl p-4 border border-dark-600">
      <div class="w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center mb-3">
        <i class="fa-solid fa-comments text-green-400"></i>
        </div>
      <h4 class="text-white font-medium mb-1">Sentiment Analysis</h4>
      <p class="text-gray-400 text-xs">Understand emotional context and tone</p>
    </div>
    <div class="bg-dark-700 rounded-xl p-4 border border-dark-600">
      <div class="w-10 h-10 bg-orange-500/20 rounded-lg flex items-center justify-center mb-3">
        <i class="fa-solid fa-tags text-orange-400"></i>
</div>
      <h4 class="text-white font-medium mb-1">Content Tagging</h4>
      <p class="text-gray-400 text-xs">Automatic categorization and labeling</p>
                </div>
            </div>
        </div>
        
<div id="processing-pipeline" class="px-6 mb-8">
  <h3 class="text-lg font-semibold text-white mb-4">Processing Pipeline</h3>
  <div class="bg-dark-700 rounded-xl p-4 border border-dark-600">
    <div class="space-y-4">
            <div class="flex items-center space-x-4">
        <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center"><span class="text-white text-sm font-medium">1</span></div>
        <div class="flex-1">
          <p class="text-white font-medium">Video Upload</p>
          <p class="text-gray-400 text-sm">Select and upload your video file</p>
                </div>
        <div class="w-4 h-4 bg-gray-600 rounded-full"></div>
      </div>
      <div class="flex items-center space-x-4">
        <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center"><span class="text-white text-sm font-medium">2</span></div>
                <div class="flex-1">
          <p class="text-white font-medium">Shot Detection</p>
          <p class="text-gray-400 text-sm">Identify scene changes and cuts</p>
                </div>
        <div class="w-4 h-4 bg-gray-600 rounded-full"></div>
                </div>
      <div class="flex items-center space-x-4">
        <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center"><span class="text-white text-sm font-medium">3</span></div>
        <div class="flex-1">
          <p class="text-white font-medium">Feature Embedding</p>
          <p class="text-gray-400 text-sm">Extract visual and audio features</p>
            </div>
        <div class="w-4 h-4 bg-gray-600 rounded-full"></div>
            </div>
      <div class="flex items-center space-x-4">
        <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center"><span class="text-white text-sm font-medium">4</span></div>
        <div class="flex-1">
          <p class="text-white font-medium">AI Analysis</p>
          <p class="text-gray-400 text-sm">Generate insights and recommendations</p>
        </div>
        <div class="w-4 h-4 bg-gray-600 rounded-full"></div>
            </div>
        </div>
    </div>
</div>

<div id="quick-actions" class="px-6 mb-8">
  <h3 class="text-lg font-semibold text-white mb-4">Quick Actions</h3>
  <div class="grid grid-cols-1 gap-3">
    <button class="bg-dark-700 rounded-xl p-4 border border-dark-600 flex items-center justify-between hover:bg-dark-600 transition-colors">
                <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center">
          <i class="fa-solid fa-upload text-purple-400"></i>
                    </div>
        <div class="text-left">
          <p class="text-white font-medium">Batch Upload</p>
          <p class="text-gray-400 text-sm">Process multiple videos at once</p>
                    </div>
                </div>
      <i class="fa-solid fa-chevron-right text-gray-400"></i>
    </button>
    <button class="bg-dark-700 rounded-xl p-4 border border-dark-600 flex items-center justify-between hover:bg-dark-600 transition-colors">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
          <i class="fa-solid fa-download text-blue-400"></i>
                </div>
        <div class="text-left">
          <p class="text-white font-medium">Export Results</p>
          <p class="text-gray-400 text-sm">Download analysis reports</p>
            </div>
        </div>
      <i class="fa-solid fa-chevron-right text-gray-400"></i>
                    </button>
    <button class="bg-dark-700 rounded-xl p-4 border border-dark-600 flex items-center justify-between hover:bg-dark-600 transition-colors">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center">
          <i class="fa-solid fa-cog text-green-400"></i>
                </div>
        <div class="text-left">
          <p class="text-white font-medium">Settings</p>
          <p class="text-gray-400 text-sm">Configure analysis parameters</p>
            </div>
      </div>
      <i class="fa-solid fa-chevron-right text-gray-400"></i>
                    </button>
            </div>
        </div>
        
<div id="usage-stats" class="px-6 mb-8">
  <h3 class="text-lg font-semibold text-white mb-4">Usage Statistics</h3>
        <div class="bg-dark-700 rounded-xl p-4 border border-dark-600">
    <div class="space-y-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
          <span class="text-white text-sm">Processing Time</span>
            </div>
        <span class="text-gray-400 text-sm">2.4 min avg</span>
            </div>
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
          <span class="text-white text-sm">Accuracy Rate</span>
        </div>
        <span class="text-gray-400 text-sm">94.7%</span>
            </div>
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-3 h-3 bg-green-500 rounded-full"></div>
          <span class="text-white text-sm">Storage Used</span>
        </div>
        <span class="text-gray-400 text-sm">1.2 GB / 5 GB</span>
      </div>
      <div class="w-full bg-dark-600 rounded-full h-2 mt-3">
        <div class="bg-gradient-to-r from-purple-500 to-blue-500 h-2 rounded-full" style="width: 24%"></div>
      </div>
    </div>
            </div>
        </div>
        
<div id="help-support" class="px-6 mb-20">
  <h3 class="text-lg font-semibold text-white mb-4">Help & Support</h3>
  <div class="space-y-3">
        <div class="bg-dark-700 rounded-xl p-4 border border-dark-600">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-yellow-500/20 rounded-lg flex items-center justify-center">
          <i class="fa-solid fa-question-circle text-yellow-400"></i>
                    </div>
                    <div>
          <h4 class="text-white font-medium">FAQ</h4>
          <p class="text-gray-400 text-sm">Common questions and answers</p>
                    </div>
                </div>
            </div>
    <div class="bg-dark-700 rounded-xl p-4 border border-dark-600">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
          <i class="fa-solid fa-book text-blue-400"></i>
        </div>
        <div>
          <h4 class="text-white font-medium">Documentation</h4>
          <p class="text-gray-400 text-sm">Complete guide and tutorials</p>
    </div>
</div>
    </div>
    <div class="bg-dark-700 rounded-xl p-4 border border-dark-600">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center">
          <i class="fa-solid fa-headset text-green-400"></i>
        </div>
        <div>
          <h4 class="text-white font-medium">Contact Support</h4>
          <p class="text-gray-400 text-sm">Get help from our team</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bottom Navigation -->
<div id="bottom-navigation" class="fixed bottom-0 left-0 right-0 bg-dark-800 border-t border-dark-600 px-6 py-3 pb-[env(safe-area-inset-bottom)]">
  <div class="flex items-center justify-between">
    <button class="flex flex-col items-center space-y-1 text-purple-400">
      <i class="fa-solid fa-home text-lg"></i>
      <span class="text-xs font-medium">Home</span>
    </button>
    <button class="flex flex-col items-center space-y-1 text-gray-400">
      <i class="fa-solid fa-compass text-lg"></i>
      <span class="text-xs font-medium">Explore</span>
    </button>
    <button class="flex flex-col items-center space-y-1 text-gray-400">
      <i class="fa-solid fa-plus-circle text-lg"></i>
      <span class="text-xs font-medium">Upload</span>
    </button>
    <button class="flex flex-col items-center space-y-1 text-gray-400">
      <i class="fa-solid fa-search text-lg"></i>
      <span class="text-xs font-medium">Research</span>
    </button>
    <button class="flex flex-col items-center space-y-1 text-gray-400">
      <i class="fa-solid fa-user text-lg"></i>
      <span class="text-xs font-medium">Profile</span>
    </button>
    </div>
</div>

<script>
/* ---------- Whisper Step 1: UI-only shell ---------- */

(() => {
  const dotColor = { idle:'bg-gray-500', yellow:'bg-yellow-500', blue:'bg-blue-500', purple:'bg-purple-500', green:'bg-green-500' };
  const statusDot = document.querySelector('#analysis-status .w-3');
  const statusText = document.querySelector('#analysis-status .text-xs');
  const statusCard = document.getElementById('analysis-status');

  const setDot = (k) => statusDot.className = `w-3 h-3 rounded-full ${dotColor[k]||dotColor.idle} animate-pulse`;
  const setStatus = (msg, k='idle', busy=false) => { statusText.textContent = msg; setDot(k); statusCard.setAttribute('aria-busy', String(busy)); };

  const presetElement = document.getElementById('sel-preset');
  const modelElement = document.getElementById('sel-model');
  const processButton = document.getElementById('run-whisper-btn');
  const selectFilesButton = document.getElementById('select-files-btn');
  const presetSingleButton = document.getElementById('preset-single');
  const presetAccuracyButton = document.getElementById('preset-accuracy');
  const runsListElement = document.getElementById('runs-list');
  const refreshButton = document.getElementById('refresh-runs');
  const selectedFilesSummaryElement = document.getElementById('selected-files-summary');
  const fileCountElement = document.getElementById('file-count');
  const filesListElement = document.getElementById('files-list');

  let selectedFiles = [];
  let selectedPreset = 'Single';
  let selectedModel = 'ggml-small.en.bin (Default)';

  /* ---- Bridge contract (provided by Android WebView) ----
     window.WhisperBridge.run(json) -> String jobId
     window.WhisperBridge.runBatch(json) -> String batchId
     window.WhisperBridge.export(jobId) -> "ok"
     window.WhisperBridge.listRuns() -> JSON string: [{jobId, uri, rtf, sidecarPath}]
     window.WhisperBridge.openFilePicker() -> String result
     window.WhisperBridge.getAllVideoFiles() -> JSON string: {files: [], count: 0}
     All may throw on error.
     
     Bridge also supports BroadcastChannel for real-time communication:
     - whisper.run: Start transcription
     - whisper.ack: Host acknowledged run
     - whisper.progress: Progress updates
     - whisper.done: Run completed
     - whisper.error: Error occurred
  ------------------------------------------------------- */

  const hasBridge = typeof window.WhisperBridge !== 'undefined';
  const isDevBuild = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

  // BroadcastChannel for real-time communication
  let broadcastChannel = null;
  if ('BroadcastChannel' in window) {
    broadcastChannel = new BroadcastChannel('whisper-ui');
    broadcastChannel.onmessage = (event) => {
      switch(event.data.type) {
        case 'whisper.ack':
            console.log('Host acknowledged run');
            break;
        case 'whisper.progress':
          console.log('Progress:', event.data.pct + '%', event.data.msg);
            break;
        case 'whisper.done':
          console.log('Run completed:', event.data);
            break;
        case 'whisper.error':
          console.error('Run error:', event.data.error);
            break;
    }
    };
  }

  const bridge = hasBridge ? {
    async openFilePicker() { return window.WhisperBridge.openFilePicker(); },
    async getAllVideoFiles() { return window.WhisperBridge.getAllVideoFiles(); },
    async runBatch(args) { 
      const batchId = window.WhisperBridge.runBatch(JSON.stringify(args));
      // Send whisper.run event via BroadcastChannel
      if (broadcastChannel) {
        broadcastChannel.postMessage({ type: 'whisper.run', ...args, jobId: batchId });
      }
      return batchId;
    },
    async run(args)   { 
      const jobId = window.WhisperBridge.run(JSON.stringify(args));
      // Send whisper.run event via BroadcastChannel
      if (broadcastChannel) {
        broadcastChannel.postMessage({ type: 'whisper.run', ...args, jobId });
      }
      return jobId;
    },
    async export(jobId){ return window.WhisperBridge.export(jobId); },
    async listRuns()  { const s = window.WhisperBridge.listRuns(); return JSON.parse(s); }
  } : mockBridge(); // fallback for browser preview

  function mockBridge() {
    // Simple in-memory stub so UI can be exercised without Android
    const mem = { runs: [] };
    return {
      async openFilePicker(){ return 'file_picker_launched'; },
      async getAllVideoFiles(){ 
        return JSON.stringify({
          files: [
            { name: 'video1.mp4', size: 15728640, uri: 'file:///sdcard/video1.mp4', format: 'mp4' },
            { name: 'movie2.avi', size: 20971520, uri: 'file:///sdcard/movie2.avi', format: 'avi' },
            { name: 'clip3.mov', size: 12582912, uri: 'file:///sdcard/clip3.mov', format: 'mov' }
          ],
          count: 3
        });
      },
      async runBatch({uris,preset,modelPath}) {
        const id = 'batch-' + Math.random().toString(36).slice(2,10);
        uris.forEach(uri => {
          mem.runs.unshift({ jobId:id, uri, rtf: Math.random()*0.8+0.3, sidecarPath:`/mock/whisper/${id}/sidecar.json` });
        });
        return id;
      },
      async run({uri,preset,modelPath}) {
        const id = 'mock-' + Math.random().toString(36).slice(2,10);
        mem.runs.unshift({ jobId:id, uri, rtf: Math.random()*0.8+0.3, sidecarPath:`/mock/whisper/${id}/sidecar.json` });
        return id;
      },
      async export(){ return 'ok'; },
      async listRuns(){ return mem.runs; }
    };
  }

  // Enable/disable Process button
  function updateProcessButtonState() {
    const hasFiles = selectedFiles.length > 0;
    processButton.disabled = !hasFiles;
    processButton.className = hasFiles
      ? 'w-full bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-semibold py-4 px-6 rounded-xl mb-4 flex items-center justify-center space-x-3 transition-all duration-200 active:scale-95'
      : 'w-full bg-dark-600 text-gray-400 font-semibold py-4 px-6 rounded-xl mb-4 flex items-center justify-center space-x-3 cursor-not-allowed opacity-60';
  }

  // Update selected files display
  function renderSelectedFilesList() {
    if (selectedFiles.length === 0) {
      selectedFilesSummaryElement.style.display = 'none';
      return;
    }
    
    selectedFilesSummaryElement.style.display = 'block';
    fileCountElement.textContent = selectedFiles.length;
    
    filesListElement.innerHTML = '';
    selectedFiles.forEach((file, index) => {
      const fileDiv = document.createElement('div');
      fileDiv.className = 'flex items-center justify-between bg-dark-700 rounded-lg p-2';
      fileDiv.innerHTML = `
        <div class="flex items-center space-x-2">
          <i class="fa-solid fa-video text-purple-400 text-xs"></i>
          <span class="text-xs text-gray-300 truncate">${file.name}</span>
        </div>
        <button class="text-gray-400 hover:text-red-400 transition-colors remove-file-btn" data-index="${index}">
          <i class="fa-solid fa-times text-xs"></i>
        </button>
      `;
      filesListElement.appendChild(fileDiv);
    });
    
    // Add remove file event listeners
    filesListElement.querySelectorAll('.remove-file-btn').forEach(btn => {
      btn.onclick = () => {
        const index = parseInt(btn.dataset.index);
        selectedFiles.splice(index, 1);
        renderSelectedFilesList();
        updateProcessButtonState();
        setStatus(`${selectedFiles.length} files selected`, 'blue', false);
      };
    });
  }

  // Preset toggles
  function updatePresetSelection(preset) {
    selectedPreset = preset;
    presetElement.textContent = preset;
    [presetSingleButton, presetAccuracyButton].forEach(btn => btn.classList.remove('ring-1','ring-purple-500','text-white'));
    const activeButton = preset === 'Single' ? presetSingleButton : presetAccuracyButton;
    activeButton.classList.add('ring-1','ring-purple-500','text-white');
  }

  // File selection handler
  selectFilesButton.onclick = async () => {
    try {
      setStatus('Opening file picker...', 'blue', true);
      
      const result = await bridge.openFilePicker();
      console.log('File picker result:', result);
      
      if (result === 'file_picker_launched') {
        setStatus('File picker opened - select your video files', 'green', false);
        toast('File picker opened - select your video files');
      } else {
        setStatus('File picker error', 'red', false);
        toast(`File picker error: ${result}`, true);
      }
    } catch (e) {
      setStatus('File picker failed', 'red', false);
      toast(`File picker failed: ${String(e)}`, true);
    }
  };

  // File selection handler (called from Android bridge)
  window.handleFileSelection = (jsonResponse) => {
    try {
      const data = JSON.parse(jsonResponse);
      
      if (data.success && data.files && data.files.length > 0) {
        selectedFiles = [...selectedFiles, ...data.files];
        renderSelectedFilesList();
        updateProcessButtonState();
        
        setStatus(`${data.files.length} files selected from picker`, 'green', false);
        toast(`Selected ${data.files.length} files from picker`);
      } else if (data.error) {
        setStatus('File selection failed', 'red', false);
        toast(`Selection failed: ${data.error}`, true);
      } else {
        setStatus('No files selected', 'yellow', false);
        toast('No files selected');
      }
    } catch (e) {
      setStatus('File selection error', 'red', false);
      toast(`Selection error: ${String(e)}`, true);
    }
  };

  // Render runs
  async function refreshRuns() {
    const runs = await bridge.listRuns();
    runsList.innerHTML = '';
    if (!runs || !runs.length) {
      runsList.innerHTML = '<div class="text-sm text-gray-500">No runs yet.</div>';
        return;
    }
    runs.forEach(r => {
      const row = document.createElement('div');
      row.className = 'bg-dark-700 rounded-xl p-4 border border-dark-600';
      row.innerHTML = `
        <div class="flex items-center space-x-4">
          <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
            <i class="fa-solid fa-waveform-lines text-white"></i>
          </div>
          <div class="flex-1 min-w-0">
            <h4 class="text-white font-medium truncate">${r.jobId}</h4>
            <p class="text-gray-400 text-xs truncate">${r.uri || ''}</p>
          </div>
          <div class="text-right">
            <p class="text-green-400 text-sm font-medium">${r.rtf ? `RTF ${Number(r.rtf).toFixed(2)}` : '—'}</p>
            <p class="text-gray-400 text-xs break-all">${r.sidecarPath || ''}</p>
          </div>
        </div>
        <div class="mt-3 flex justify-end">
          <button data-job="${r.jobId}" class="export-btn text-xs px-3 py-1 rounded-lg bg-dark-600 border border-dark-500 hover:bg-dark-500">Export</button>
        </div>
      `;
      runsList.appendChild(row);
    });

    // bind export buttons
    document.querySelectorAll('.export-btn').forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute('data-job');
        try {
          await bridge.export(id);
          toast(`Exported ${id}`);
        } catch (e) {
          toast(`Export failed: ${String(e)}`, true);
        }
      };
    });
  }

  // Tiny toast
  let toastTimer = null;
  function toast(msg, err=false) {
    const t = document.createElement('div');
    t.className = `fixed bottom-20 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg text-sm ${err ? 'bg-red-600' : 'bg-dark-600'} border border-dark-500`;
    t.textContent = msg;
    document.body.appendChild(t);
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> t.remove(), 1800);
  }

  // Preset buttons
  presetSingleButton.onclick = () => updatePresetSelection('Single');
  presetAccuracyButton.onclick = () => updatePresetSelection('Accuracy');

  // Process files
  processButton.onclick = async () => {
    if (selectedFiles.length === 0) {
      toast('Please select at least one video file', true);
      return;
    }
    
    try {
      setStatus('Processing files...', 'purple', true);
      
      // Extract URIs from selected files
      const uris = selectedFiles.map(file => file.uri);
      
      // Start batch processing
      const batchId = await bridge.runBatch({
        uris: uris,
        preset: selectedPreset,
        modelPath: selectedModel
      });
      
      setStatus(`Processing ${selectedFiles.length} files...`, 'purple', true);
      toast(`Started processing ${selectedFiles.length} files (Batch: ${batchId})`);
      
      // Navigate to Step 2 after successful submission
      setTimeout(() => {
        if (window.AndroidInterface && window.AndroidInterface.openWhisperStep2) {
          window.AndroidInterface.openWhisperStep2();
        } else {
          console.log('AndroidInterface not available, simulating navigation to Step 2');
          toast('Would navigate to Step 2 (Processing)');
          // For testing, we can simulate the navigation
          setStatus('Processing started - navigate to Step 2', 'green', false);
        }
      }, 2000);
      
    } catch (e) {
      setStatus('Processing failed', 'red', false);
      toast(`Processing failed: ${String(e)}`, true);
    }
  };

  // Manual refresh
  refreshButton.onclick = refreshRuns;

  // Defaults
  updatePresetSelection('Single');
  updateProcessButtonState();
  renderSelectedFilesList();
  refreshRuns();

  // Keep Tailwind aware of dot colors even if CDN prunes (defensive)
  const keep = document.createElement('div');
  keep.className = 'hidden bg-yellow-500 bg-blue-500 bg-purple-500 bg-green-500 bg-gray-500';
  document.body.appendChild(keep);
})();

/* ===================== STAGING (Step 0) — UI ONLY ===================== */
/* Bridge contract (if running in Android WebView):
   window.StagingBridge.addTree()             -> String treeUri or ""
   window.StagingBridge.listTrees()           -> JSON string: [{uri, label, authority, isLocal}]
   window.StagingBridge.removeTree(uri)       -> "ok"
   window.StagingBridge.enumerateAll(filters) -> JSON string: [{uri, name, authority, isLocal, sizeBytes, durationMs, lastModified, mime, codec}]
   window.StagingBridge.persistedPermissions()-> JSON string: [uri,...]
   (A mock is provided for browser.) */

(function () {
  const hasBridge = typeof window.StagingBridge !== 'undefined';
  const bridge = hasBridge ? {
    async addTree() { return window.StagingBridge.addTree(); },
    async listTrees() { return JSON.parse(window.StagingBridge.listTrees()); },
    async removeTree(uri){ return window.StagingBridge.removeTree(uri); },
    async enumerateAll(filters){ return JSON.parse(window.StagingBridge.enumerateAll(JSON.stringify(filters))); },
    async persistedPermissions(){ return JSON.parse(window.StagingBridge.persistedPermissions()); },
    async probe(uri){ if (window.StagingBridge.probe) return JSON.parse(window.StagingBridge.probe(uri)); throw new Error('no probe'); }
  } : mockBridge();

  // ---- State
  let filters = { recursive: true, exts: new Set(['mp4','mov','mkv','webm']), minDurationSec: 0 };
  let trees = [];    // [{uri,label,authority,isLocal}]
  let items = [];    // [{uri,name,authority,isLocal,sizeBytes,durationMs,lastModified,mime,codec}]
  let included = new Set(); // included URIs

  // ---- Elements
  const folderListEl = document.getElementById('folder-list');
  const folderCountEl = document.getElementById('folder-count');
  const fileCountEl = document.getElementById('file-count');
  const localCountEl = document.getElementById('local-count');
  const cloudCountEl = document.getElementById('cloud-count');
  const rowsEl = document.getElementById('staging-rows');
  const selectionSummaryEl = document.getElementById('selection-summary');

  // ---- Controls wiring
  document.getElementById('add-folder-btn').onclick = async () => {
    const uri = await bridge.addTree();
    if (uri) await refreshTreesAndFiles();
  };
  document.getElementById('refresh-staging-btn').onclick = refreshTreesAndFiles;

  document.getElementById('check-perms-btn')?.addEventListener('click', async () => {
    const perms = await bridge.persistedPermissions();
    toast(`Persisted: ${perms.length} permission(s)`);
    console.log('[persistedUriPermissions]', perms);
  });

  document.getElementById('recursive-toggle').onchange = async (e) => {
    filters.recursive = !!e.target.checked;
    await refreshFilesOnly();
  };
  document.querySelectorAll('.ext-filter').forEach(cb => {
    cb.onchange = async (e) => {
      if (e.target.checked) filters.exts.add(e.target.value); else filters.exts.delete(e.target.value);
      await refreshFilesOnly();
    }
  });
  document.getElementById('min-duration').onchange = async (e) => {
    const v = Math.max(0, Number(e.target.value||0));
    filters.minDurationSec = v;
    await refreshFilesOnly();
  };

  document.getElementById('toggle-all').onchange = (e) => {
    if (e.target.checked) items.forEach(it => included.add(it.uri)); else included.clear();
    renderRows();
    updateSelectionSummary();
  };

  // ---- Rendering
  function renderFolders() {
    folderListEl.innerHTML = '';
    folderCountEl.textContent = `${trees.length} folder${trees.length===1?'':'s'}`;
    if (!trees.length) {
      folderListEl.innerHTML = '<div class="text-gray-500">No folders yet. Click <span class="text-purple-400">Add Folder</span>.</div>';
      return;
    }
    trees.forEach(t => {
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between bg-dark-800 border border-dark-600 rounded-lg px-3 py-2';
      row.innerHTML = `
        <div class="min-w-0">
          <div class="text-white truncate">${escapeHtml(t.label || t.uri)}</div>
          <div class="text-[11px] text-gray-400 truncate">${t.authority}</div>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-[10px] px-2 py-0.5 rounded-full ${t.isLocal ? 'bg-green-500/20 text-green-300' : 'bg-blue-500/20 text-blue-300'}">${t.isLocal ? 'Local' : providerName(t.authority)}</span>
          <button class="text-[11px] bg-dark-700 border border-dark-500 px-2 py-1 rounded remove-folder">Remove</button>
        </div>
    `;
      row.querySelector('.remove-folder').onclick = async () => {
        await bridge.removeTree(t.uri);
        await refreshTreesAndFiles();
      };
      folderListEl.appendChild(row);
    });
  }

  function renderRows() {
    rowsEl.innerHTML = '';
    if (!items.length) {
      rowsEl.innerHTML = `<tr><td colspan="7" class="px-4 py-6 text-center text-gray-500">No matching videos.</td></tr>`;
      return;
    }
    const fmtDur = ms => {
      if (!Number.isFinite(ms) || ms <= 0) return '—';
      const s = Math.round(ms / 1000);
      const m = Math.floor(s/60), r = s%60;
      const h = Math.floor(m/60), rm = m%60;
      return h ? `${h}:${rm.toString().padStart(2,'0')}:${r.toString().padStart(2,'0')}` : `${m}:${r.toString().padStart(2,'0')}`;
    };
    const fmtSz = b => {
      if (!Number.isFinite(b) || b<0) return '—';
      const m = b/1024/1024;
      return m>=1024 ? `${(m/1024).toFixed(1)} GB` : `${m.toFixed(1)} MB`;
    };

    items.forEach(it => {
      const tr = document.createElement('tr');
      tr.className = 'border-t border-dark-600 hover:bg-dark-800';
      tr.innerHTML = `
        <td class="px-4 py-2"><input type="checkbox" class="row-include accent-purple-500" ${included.has(it.uri)?'checked':''} data-uri="${escapeHtml(it.uri)}"></td>
        <td class="px-4 py-2">
          <div class="text-white truncate">${escapeHtml(it.name || '(unnamed)')}</div>
          <div class="text-[11px] text-gray-400">${(it.mime||'video/*')}</div>
        </td>
        <td class="px-4 py-2">
          <span class="text-[10px] px-2 py-0.5 rounded-full ${it.isLocal ? 'bg-green-500/20 text-green-300' : 'bg-blue-500/20 text-blue-300'}">${it.isLocal?'Local':providerName(it.authority)}</span>
        </td>
        <td class="px-4 py-2 text-gray-300">${fmtDur(it.durationMs)}</td>
        <td class="px-4 py-2 text-gray-300">${fmtSz(it.sizeBytes)}</td>
        <td class="px-4 py-2 text-gray-400 truncate" title="${escapeHtml(it.uri)}">${escapeHtml(it.uri)}</td>
        <td class="px-4 py-2">
          <button class="probe-btn text-[11px] bg-dark-700 border border-dark-500 px-2 py-1 rounded" data-uri="${escapeHtml(it.uri)}">Probe</button>
        </td>
      `;
      rowsEl.appendChild(tr);
    });

    rowsEl.querySelectorAll('.row-include').forEach(cb => {
      cb.onchange = e => {
        const u = e.target.getAttribute('data-uri');
        if (e.target.checked) included.add(u); else included.delete(u);
        updateSelectionSummary();
      };
    });

    rowsEl.querySelectorAll('.probe-btn').forEach(btn => {
      btn.onclick = async () => {
        toast('Probing…');
        try {
          const one = await (bridge.probe ? bridge.probe(btn.getAttribute('data-uri')) : Promise.resolve({}));
          toast(`Duration ≈ ${Math.round((one.durationMs||0)/1000)}s${one.codec?`, codec=${one.codec}`:''}`);
        } catch {
          toast('Probe failed', true);
        }
      };
    });

    updateSelectionSummary();
  }

  function updateTopCounts() {
    fileCountEl.textContent = String(items.length);
    const local = items.filter(i => i.isLocal).length;
    localCountEl.textContent = String(local);
    cloudCountEl.textContent = String(items.length - local);
  }

  function updateSelectionSummary() {
    const chosen = items.filter(i => included.has(i.uri));
    const totalBytes = chosen.reduce((a,b)=> a + (b.sizeBytes||0), 0);
    const totalDurMs = chosen.reduce((a,b)=> a + (b.durationMs||0), 0);
    selectionSummaryEl.textContent = `Selected ${chosen.length} • ${fmtMb(totalBytes)} • ~${fmtClock(totalDurMs)}`;
  }

  function fmtMb(bytes) { const mb=bytes/1024/1024; return !bytes? '0.0 MB' : (mb>=1024? `${(mb/1024).toFixed(1)} GB` : `${mb.toFixed(1)} MB`); }
  function fmtClock(ms){ const s=Math.round(ms/1000), m=Math.floor(s/60), r=s%60, h=Math.floor(m/60), rm=m%60; return h?`${h}:${rm.toString().padStart(2,'0')}:${r.toString().padStart(2,'0')}`:`${m}:${r.toString().padStart(2,'0')}`; }

  // ---- Data ops
  async function refreshTreesAndFiles() { trees = await bridge.listTrees(); renderFolders(); await refreshFilesOnly(); }
  async function refreshFilesOnly() {
    const res = await bridge.enumerateAll({ recursive: !!filters.recursive, exts: Array.from(filters.exts), minDurationMs: (Number(filters.minDurationSec)||0)*1000 });
    // Local-first, then newest
    items = res.sort((a,b) => (Number(b.isLocal)-Number(a.isLocal)) || ((b.lastModified||0)-(a.lastModified||0)));
    const existing = new Set(items.map(i=>i.uri)); included = new Set(Array.from(included).filter(u => existing.has(u)));
    updateTopCounts();
    renderRows();
  }

  // ---- Utils
  function providerName(auth){ if(!auth) return 'Unknown'; if(auth.includes('externalstorage')||auth.includes('media.documents')) return 'MediaStore'; if(auth.includes('docs.storage')) return 'Google Drive'; if(auth.includes('onedrive')) return 'OneDrive'; if(auth.includes('dropbox')) return 'Dropbox'; return auth.split('.').slice(-1)[0]; }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  let toastTimer=null; function toast(msg, err=false){ const t=document.createElement('div'); t.className=`fixed bottom-20 left-1/2 -translate-x-1/2 px-3 py-2 rounded-lg text-xs ${err?'bg-red-600':'bg-dark-700'} border border-dark-500`; t.textContent=msg; document.body.appendChild(t); clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.remove(),1600); }

  // ---- Mock bridge (browser)
  function mockBridge(){
    const LS_KEY='staging_trees_mock'; let trees = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
    return {
      async addTree(){ const u=`content://mock/${Math.random().toString(36).slice(2)}`; trees.push({uri:u,label:'Mock Folder',authority:'com.android.externalstorage.documents',isLocal:true}); localStorage.setItem(LS_KEY,JSON.stringify(trees)); return u; },
      async listTrees(){ return trees; },
      async removeTree(uri){ trees = trees.filter(t=>t.uri!==uri); localStorage.setItem(LS_KEY,JSON.stringify(trees)); return 'ok'; },
      async enumerateAll(filtersJson){
        const f = typeof filtersJson==='string' ? JSON.parse(filtersJson) : filtersJson;
        const samples = [
          {name:'Camera_0001.mp4', ext:'mp4', dur:43,   sz:3.2,  auth:'com.android.providers.media.documents', local:true},
          {name:'Downloads_webinar.mkv', ext:'mkv', dur:2712, sz:127.8,auth:'com.android.providers.downloads.documents', local:true},
          {name:'Drive_meeting.mov', ext:'mov', dur:942, sz:28.3, auth:'com.google.android.apps.docs.storage', local:false},
          {name:'Whatsapp_clip.webm', ext:'webm', dur:15, sz:1.2, auth:'com.whatsapp.provider.media', local:true},
        ];
        return samples
          .filter(s => f.exts.includes(s.ext))
          .filter(s => s.dur*1000 >= (f.minDurationMs||0))
          .map((s,i)=>({
            uri:`content://${s.ext}/${i}`,
            name:s.name,
            authority:s.auth,
            isLocal: !!s.local,
            sizeBytes: Math.round(s.sz*1024*1024),
            durationMs: s.dur*1000,
            lastModified: Date.now() - i*100000,
            mime: `video/${s.ext}`,
            codec: `video/${s.ext}`
          }));
      },
      async persistedPermissions(){ return trees.map(t=>t.uri); },
      async probe(uri){ return { durationMs: 15000, codec: 'video/mp4' }; }
    };
  }

  // Initialize
  console.log('Whisper File Selection initialized');
  setStatus('Ready to select video files', 'green', false);
  
  // Kickoff
  refreshTreesAndFiles();
})();
</script>

</body>
</html>