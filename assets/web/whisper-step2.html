<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script> window.FontAwesomeConfig = { autoReplaceSvg: 'nest'};</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>::-webkit-scrollbar { display: none;} * { font-family: 'Inter', sans-serif; }</style>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { dark: { 900:'#0a0a0a',800:'#1a1a1a',700:'#2a2a2a',600:'#3a3a3a' }}}}
    }
  </script>
</head>
<body class="bg-dark-900 text-white overflow-x-hidden">

<!-- Status Bar -->
<div id="status-bar" class="flex justify-between items-center px-4 py-2 bg-dark-800 text-xs text-gray-300">
  <div class="flex items-center space-x-1">
    <div class="w-1 h-1 bg-white rounded-full"></div>
    <div class="w-1 h-1 bg-white rounded-full"></div>
    <div class="w-1 h-1 bg-gray-600 rounded-full"></div>
    <span class="ml-2">Verizon</span>
  </div>
  <div class="font-medium">9:41</div>
  <div class="flex items-center space-x-1">
    <i class="fa-solid fa-signal text-xs"></i>
    <i class="fa-solid fa-wifi text-xs"></i>
    <div class="w-6 h-3 border border-white rounded-sm">
      <div class="w-4 h-2 bg-white rounded-sm m-0.5"></div>
    </div>
  </div>
</div>

<!-- App Header -->
<div id="app-header" class="flex items-center justify-between px-6 py-4 bg-dark-800 border-b border-dark-600">
  <div class="flex items-center space-x-3">
    <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
      <i class="fa-solid fa-play text-white text-sm"></i>
    </div>
    <div>
      <h1 class="text-lg font-semibold text-white">DeepDive</h1>
      <p class="text-xs text-gray-400">AI Video Analysis</p>
    </div>
  </div>
  <div class="flex items-center space-x-3">
    <button class="w-8 h-8 bg-dark-600 rounded-full flex items-center justify-center"><i class="fa-solid fa-bell text-gray-300 text-sm"></i></button>
    <button class="w-8 h-8 bg-dark-600 rounded-full flex items-center justify-center"><i class="fa-solid fa-user text-gray-300 text-sm"></i></button>
  </div>
</div>

<!-- Main Dashboard Section -->
<div id="main-dashboard" class="px-6 py-8">
  <!-- Status Card with Invariants -->
  <div id="status-card" class="bg-gradient-to-r from-dark-700 to-dark-600 rounded-2xl p-6 mb-6 border border-dark-600">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold text-white">Whisper Deterministic Pipeline</h2>
      <div class="flex items-center space-x-2">
        <div id="svc-led" class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        <span class="text-sm text-green-400 font-medium">Service Contract Ready</span>
      </div>
    </div>
    <p class="text-gray-300 mb-4">Pick URI → Model Path → Preset → <span class="text-white font-semibold">RUN</span> → View Sidecar → <span class="text-white font-semibold">VERIFY</span> → <span class="text-white font-semibold">EXPORT</span>.</p>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-xs text-gray-300">
      <div class="flex items-center space-x-2"><i class="fa-solid fa-clock text-purple-400"></i><span>Segment: <b id="inv-seg">30s</b> • Overlap: <b id="inv-olap">1s</b></span></div>
      <div class="flex items-center space-x-2"><i class="fa-solid fa-waveform-lines text-blue-400"></i><span>Timestamp: <b>ExtractorPTS</b> • Decode: <b>AAC_HW_FIRST</b></span></div>
      <div class="flex items-center space-x-2"><i class="fa-solid fa-gauge-high text-teal-400"></i><span>Decode policy: greedy (beam=1, temp=0.0)</span></div>
    </div>
  </div>

  <!-- Quick Stats (unchanged visuals) -->
  <div id="quick-stats" class="grid grid-cols-3 gap-3 mb-8">
    <div class="bg-dark-700 rounded-xl p-4 border border-dark-600">
      <div class="text-center"><div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center mx-auto mb-2"><i class="fa-solid fa-video text-purple-400"></i></div>
      <p id="stat-videos" class="text-2xl font-bold text-white">0</p><p class="text-xs text-gray-400">Runs</p></div>
    </div>
    <div class="bg-dark-700 rounded-xl p-4 border border-dark-600">
      <div class="text-center"><div class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center mx-auto mb-2"><i class="fa-solid fa-brain text-blue-400"></i></div>
      <p id="stat-deterministic" class="text-2xl font-bold text-white">0</p><p class="text-xs text-gray-400">Deterministic ✓</p></div>
    </div>
    <div class="bg-dark-700 rounded-xl p-4 border border-dark-600">
      <div class="text-center"><div class="w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center mx-auto mb-2"><i class="fa-solid fa-gauge text-green-400"></i></div>
      <p id="stat-rtf" class="text-2xl font-bold text-white">—</p><p class="text-xs text-gray-400">Avg RTF</p></div>
    </div>
  </div>
</div>

<!-- Main Action Section -->
<div id="main-actions" class="px-6 mb-8">
  <div class="bg-dark-700 rounded-2xl p-6 border border-dark-600">
    <h3 class="text-lg font-semibold text-white mb-6">Start New Whisper Run</h3>

    <!-- Input row: URI + ModelPath -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
      <div>
        <label class="text-xs text-gray-400">Input URI (audio/video)</label>
        <div class="flex items-center space-x-2 mt-1">
          <input id="uri-input" type="text" placeholder="file:///sdcard/Movies/sample.mp4" class="w-full bg-dark-800 border border-dark-600 rounded-lg px-3 py-2 text-sm outline-none focus:border-purple-500">
          <button id="choose-video-btn" class="px-3 py-2 bg-dark-600 rounded-lg text-sm"><i class="fa-solid fa-folder-open"></i></button>
        </div>
      </div>
      <div>
        <label class="text-xs text-gray-400">Model Path (on device)</label>
        <div class="flex items-center space-x-2 mt-1">
          <input id="model-path-input" type="text" value="/sdcard/models/ggml-small-q5_1.bin" class="w-full bg-dark-800 border border-dark-600 rounded-lg px-3 py-2 text-sm outline-none focus:border-purple-500">
          <button id="compute-model-sha-btn" class="px-3 py-2 bg-dark-600 rounded-lg text-sm" title="Optional: compute SHA from local file for display"><i class="fa-solid fa-hashtag"></i></button>
        </div>
        <div class="text-xs text-gray-400 mt-1">Model SHA: <span id="model-sha-label" class="text-gray-300">unknown</span></div>
      </div>
    </div>

    <!-- Preset selector -->
    <div class="flex items-center space-x-2 mb-4">
      <span class="text-xs text-gray-400 mr-2">Preset</span>
      <button id="preset-single" class="px-3 py-2 rounded-lg bg-purple-600 text-white text-sm">Single</button>
      <button id="preset-accuracy" class="px-3 py-2 rounded-lg bg-dark-600 text-gray-300 text-sm">Accuracy</button>
      <span class="ml-3 text-xs text-gray-500">Determinism-safe presets only.</span>
    </div>

    <!-- Run / Status -->
    <button id="run-analysis-btn" class="w-full bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-semibold py-4 px-6 rounded-xl mb-4 flex items-center justify-center space-x-3 transition-all duration-200 active:scale-95">
      <i class="fa-solid fa-play text-xl"></i><span class="text-lg">Run</span>
    </button>

    <!-- Status Information -->
    <div id="analysis-status" class="bg-dark-800 rounded-xl p-4 border border-dark-600">
      <div class="flex items-center space-x-3">
        <div id="status-led" class="w-3 h-3 bg-gray-500 rounded-full"></div>
        <div>
          <p class="text-sm font-medium text-white">Current Step</p>
          <p id="status-text" class="text-xs text-gray-400">Ready - Fill URI & Model path</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Recent Runs (sidecars as source of truth) -->
<div id="recent-projects" class="px-6 mb-8">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-lg font-semibold text-white">Recent Runs</h3>
    <div class="flex items-center space-x-2">
      <button id="refresh-runs-btn" class="px-3 py-2 bg-dark-700 rounded-lg text-sm border border-dark-600"><i class="fa-solid fa-rotate"></i> Refresh</button>
      <button id="export-all-btn" class="px-3 py-2 bg-dark-700 rounded-lg text-sm border border-dark-600"><i class="fa-solid fa-box-archive"></i> Export All</button>
    </div>
  </div>
  <div id="runs-list" class="space-y-3">
    <!-- Populated dynamically -->
  </div>
</div>

<!-- Keep rest of sections as-is (tools, pipeline, quick actions, usage stats, help, bottom nav) -->
<!-- Analysis Tools Section (unchanged visuals) -->
<div id="analysis-tools" class="px-6 mb-8">
  <h3 class="text-lg font-semibold text-white mb-4">Analysis Tools</h3>
  <div class="grid grid-cols-2 gap-3">
    <div class="bg-dark-700 rounded-xl p-4 border border-dark-600"><div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center mb-3"><i class="fa-solid fa-waveform-lines text-purple-400"></i></div><h4 class="text-white font-medium mb-1">Audio Analysis</h4><p class="text-gray-400 text-xs">Analyze speech patterns and audio content</p></div>
    <div class="bg-dark-700 rounded-xl p-4 border border-dark-600"><div class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center mb-3"><i class="fa-solid fa-eye text-blue-400"></i></div><h4 class="text-white font-medium mb-1">Visual Recognition</h4><p class="text-gray-400 text-xs">Identify objects, scenes, and activities</p></div>
    <div class="bg-dark-700 rounded-xl p-4 border border-dark-600"><div class="w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center mb-3"><i class="fa-solid fa-comments text-green-400"></i></div><h4 class="text-white font-medium mb-1">Sentiment Analysis</h4><p class="text-gray-400 text-xs">Understand emotional context and tone</p></div>
    <div class="bg-dark-700 rounded-xl p-4 border border-dark-600"><div class="w-10 h-10 bg-orange-500/20 rounded-lg flex items-center justify-center mb-3"><i class="fa-solid fa-tags text-orange-400"></i></div><h4 class="text-white font-medium mb-1">Content Tagging</h4><p class="text-gray-400 text-xs">Automatic categorization and labeling</p></div>
  </div>
</div>

<!-- Bottom Navigation -->
<div id="bottom-navigation" class="fixed bottom-0 left-0 right-0 bg-dark-800 border-t border-dark-600 px-6 py-3">
  <div class="flex items-center justify-between">
    <button class="flex flex-col items-center space-y-1 text-purple-400"><i class="fa-solid fa-home text-lg"></i><span class="text-xs font-medium">Home</span></button>
    <button class="flex flex-col items-center space-y-1 text-gray-400"><i class="fa-solid fa-compass text-lg"></i><span class="text-xs font-medium">Explore</span></button>
    <button class="flex flex-col items-center space-y-1 text-gray-400"><i class="fa-solid fa-plus-circle text-lg"></i><span class="text-xs font-medium">Upload</span></button>
    <button class="flex flex-col items-center space-y-1 text-gray-400"><i class="fa-solid fa-search text-lg"></i><span class="text-xs font-medium">Research</span></button>
    <button class="flex flex-col items-center space-y-1 text-gray-400"><i class="fa-solid fa-user text-lg"></i><span class="text-xs font-medium">Profile</span></button>
  </div>
</div>

<script>
/* ============================
   Connector Interface
   ============================
   AndroidBridgeConnector expects a WebView bridge object `window.AndroidWhisper`
   with methods:
     - run(jsonStr) -> string job_id
     - export(jobId) -> void
     - listSidecars() -> json string of Sidecar[]
     - verify(jobId) -> json string {"ok":bool,"failedField":string|null,"rtf":number|null}
   Sidecar schema fields used: job_id, uri, rtf, preset, model_sha/modelSha256, audio_sha/audio_sha256,
   transcript_sha, segments_sha.
*/

class AndroidBridgeConnector {
  async run(uri, preset, modelPath, threadsHint) {
    const payload = JSON.stringify({ uri, preset, modelPath, threads: threadsHint ?? Math.max(1, Math.floor(navigator.hardwareConcurrency/2)||1) });
    const jobId = window.AndroidWhisper.run(payload);
    return jobId;
  }
  async export(jobId) {
    window.AndroidWhisper.export(jobId);
  }
  async listRuns() {
    const json = window.AndroidWhisper.listSidecars();
    const arr = typeof json === 'string' ? JSON.parse(json) : json;
    return arr.map(this._normalizeSidecar);
  }
  async verify(jobId) {
    const json = window.AndroidWhisper.verify(jobId);
    const res = typeof json === 'string' ? JSON.parse(json) : json;
    return res;
  }
  _normalizeSidecar(js) {
    return {
      jobId: js.job_id || js.jobId,
      uri: js.uri,
      rtf: (js.rtf ?? null),
      preset: js.preset ?? 'Single',
      modelSha: js.model_sha || js.modelSha256 || '',
      audioSha: js.audio_sha || js.audio_sha256 || '',
      transcriptSha: js.transcript_sha || '',
      segmentsSha: js.segments_sha || ''
    };
  }
}

/* MockConnector: browser dev fallback (no Android service). */
class MockConnector {
  constructor(){ this._k='mock_sidecars'; this._touchDB(); }
  _touchDB(){ if(!localStorage.getItem(this._k)) localStorage.setItem(this._k, JSON.stringify({})); }
  _db(){ return JSON.parse(localStorage.getItem(this._k)||'{}'); }
  _save(db){ localStorage.setItem(this._k, JSON.stringify(db)); }
  async run(uri,preset,modelPath,threads){
    const id = 'job_' + Math.random().toString(36).slice(2,10);
    const db = this._db();
    db[id] = {
      job_id:id, uri, preset,
      model_sha: 'sha_mock_'+(modelPath.split('/').pop()||''),
      audio_sha: 'sha_audio_'+(uri.split('/').pop()||''),
      transcript_sha: 'sha_txt_'+Math.random().toString(36).slice(2,6),
      segments_sha: 'sha_seg_'+Math.random().toString(36).slice(2,6),
      rtf: (0.4 + Math.random()*0.6)
    };
    this._save(db);
    return id;
  }
  async export(jobId){ /* noop */ }
  async listRuns(){
    const db = this._db();
    return Object.values(db).reverse().map(js => ({
      jobId: js.job_id, uri: js.uri, rtf: js.rtf, preset: js.preset,
      modelSha: js.model_sha, audioSha: js.audio_sha,
      transcriptSha: js.transcript_sha, segmentsSha: js.segments_sha
    }));
  }
  async verify(jobId){
    const ok = Math.random() > 0.1; // 90% deterministic in mock
    return { ok, failedField: ok ? null : (['model','audio','segments','transcript'][Math.floor(Math.random()*4)]), rtf: (0.4 + Math.random()*0.6) };
  }
}

const connector = (window.AndroidWhisper ? new AndroidBridgeConnector() : new MockConnector());

/* ============================
   Minimal state & helpers
   ============================ */
const state = {
  selectedUri: '',
  preset: 'Single',
  modelPath: '/sdcard/models/ggml-small-q5_1.bin',
  modelSha: 'unknown',
  runs: []
};

function $(sel){ return document.querySelector(sel); }
function setStatus(msg, color){ $('#status-text').textContent = msg; const c = color||'gray'; const led=$('#status-led'); led.className=`w-3 h-3 rounded-full bg-${c}-500`; }
function setSvcLed(ok){ const led=$('#svc-led'); led.className = `w-2 h-2 rounded-full ${ok?'bg-green-500 animate-pulse':'bg-red-500'}`; }

/* ============================
   UI Bindings
   ============================ */
async function refreshRuns(){
  const runs = await connector.listRuns();
  state.runs = runs;
  $('#stat-videos').textContent = runs.length;
  const detCount = runs.filter(r => r.deterministic === true).length;
  $('#stat-deterministic').textContent = detCount;
  const avgRtf = runs.length ? (runs.reduce((s,r)=>s+(r.rtf||0),0)/runs.length).toFixed(2) : '—';
  $('#stat-rtf').textContent = isNaN(avgRtf)?'—':avgRtf;

  const container = $('#runs-list');
  container.innerHTML = '';
  runs.forEach(r => {
    const row = document.createElement('div');
    row.className = 'bg-dark-700 rounded-xl p-4 border border-dark-600';
    row.innerHTML = `
      <div class="flex items-center space-x-4">
        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
          <i class="fa-solid fa-waveform-lines text-white"></i>
        </div>
        <div class="flex-1">
          <h4 class="text-white font-medium">${r.jobId}</h4>
          <p class="text-gray-400 text-xs break-all">${r.uri}</p>
          <p class="text-gray-500 text-xs">preset=${r.preset} • modelSHA=${(r.modelSha||'').slice(0,12)}…</p>
        </div>
        <div class="text-right">
          <p class="text-green-400 text-sm font-medium">${r.rtf?`RTF ${r.rtf.toFixed(2)}`:'RTF —'}</p>
          <p id="badge-${r.jobId}" class="text-gray-400 text-xs">Not verified</p>
          <div class="flex space-x-2 mt-2">
            <button class="px-3 py-1 bg-dark-600 rounded text-sm border border-dark-500 hover:bg-dark-500" data-verify="${r.jobId}"><i class="fa-solid fa-check"></i> Verify</button>
            <button class="px-3 py-1 bg-dark-600 rounded text-sm border border-dark-500 hover:bg-dark-500" data-export="${r.jobId}"><i class="fa-solid fa-box-archive"></i> Export</button>
          </div>
        </div>
      </div>
    `;
    container.appendChild(row);
  });
}

async function handleRun(){
  const uri = $('#uri-input').value.trim();
  const modelPath = $('#model-path-input').value.trim();
  if(!uri){ setStatus('URI required', 'red'); return; }
  if(!modelPath){ setStatus('Model path required', 'red'); return; }
  setStatus('Enqueuing…', 'yellow');
  try{
    const jobId = await connector.run(uri, state.preset, modelPath, Math.max(1, Math.floor((navigator.hardwareConcurrency||4)/2)));
    setStatus(`Enqueued ${jobId}`, 'blue');
    await refreshRuns();
  }catch(e){
    setStatus('RUN failed: '+(e.message||e), 'red');
  }
}

async function handleVerify(jobId){
  setStatus(`Verifying ${jobId}…`, 'yellow');
  try{
    const res = await connector.verify(jobId);
    const badge = document.getElementById(`badge-${jobId}`);
    if(res.ok){
      badge.className = 'text-green-400 text-xs'; badge.textContent = 'Deterministic ✓';
    }else{
      badge.className = 'text-red-400 text-xs'; badge.textContent = `Mismatch: ${res.failedField||'unknown'}`;
    }
    setStatus(`Verify ${jobId}: ${res.ok?'Deterministic ✓':'Mismatch'}`, res.ok?'green':'red');
    await refreshRuns();
  }catch(e){
    setStatus('Verify failed: '+(e.message||e), 'red');
  }
}

async function handleExport(jobId){
  setStatus(`Exporting ${jobId}…`, 'yellow');
  try{
    await connector.export(jobId);
    setStatus(`Exported ${jobId} → /sdcard/MiraWhisper/out/${jobId}`, 'green');
  }catch(e){
    setStatus('Export failed: '+(e.message||e), 'red');
  }
}

function wireRunsListDelegates(){
  const container = $('#runs-list');
  container.addEventListener('click', (e) => {
    const t = e.target.closest('button');
    if(!t) return;
    const v = t.getAttribute('data-verify');
    const x = t.getAttribute('data-export');
    if(v) handleVerify(v);
    if(x) handleExport(x);
  });
}

/* ============================
   Event Hooks
   ============================ */
document.getElementById('preset-single').addEventListener('click', () => {
  state.preset = 'Single';
  document.getElementById('preset-single').className='px-3 py-2 rounded-lg bg-purple-600 text-white text-sm';
  document.getElementById('preset-accuracy').className='px-3 py-2 rounded-lg bg-dark-600 text-gray-300 text-sm';
  setStatus('Preset: Single', 'gray');
});
document.getElementById('preset-accuracy').addEventListener('click', () => {
  state.preset = 'Accuracy';
  document.getElementById('preset-accuracy').className='px-3 py-2 rounded-lg bg-purple-600 text-white text-sm';
  document.getElementById('preset-single').className='px-3 py-2 rounded-lg bg-dark-600 text-gray-300 text-sm';
  setStatus('Preset: Accuracy', 'gray');
});

document.getElementById('choose-video-btn').addEventListener('click', () => {
  // Browser file picker to fill URI input; service still needs a file:// or content:// URI on device.
  const input = document.createElement('input'); input.type='file'; input.accept='audio/*,video/*';
  input.addEventListener('change', (e)=>{
    if(e.target.files && e.target.files[0]){
      // For desktop dev we show a fake file URI; on device you should paste a real content:// or file:// path.
      const f = e.target.files[0];
      const fakeUri = `file:///local/${encodeURIComponent(f.name)}`;
      document.getElementById('uri-input').value = fakeUri;
      setStatus(`Selected ${f.name}`, 'blue');
      document.getElementById('status-led').className='w-3 h-3 bg-blue-500 rounded-full';
    }
  });
  input.click();
});

document.getElementById('compute-model-sha-btn').addEventListener('click', async () => {
  // Optional: compute SHA-256 for display if user selects a local file.
  const picker = document.createElement('input'); picker.type='file';
  picker.addEventListener('change', async (e)=>{
    if(e.target.files && e.target.files[0]){
      const buf = await e.target.files[0].arrayBuffer();
      const hash = await crypto.subtle.digest('SHA-256', buf);
      const hex = [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join('');
      document.getElementById('model-sha-label').textContent = hex;
      setStatus('Computed model SHA (display only)', 'gray');
    }
  });
  picker.click();
});

document.getElementById('run-analysis-btn').addEventListener('click', handleRun);
document.getElementById('refresh-runs-btn').addEventListener('click', refreshRuns);
document.getElementById('export-all-btn').addEventListener('click', async () => {
  for(const r of state.runs){ await connector.export(r.jobId); }
  setStatus('Exported all runs', 'green');
});

wireRunsListDelegates();

/* ============================
   Init
   ============================ */
(async function init(){
  try { setSvcLed(true); } catch { setSvcLed(false); }
  await refreshRuns();
})();
</script>

</body>
</html>
