<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script> window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    ::-webkit-scrollbar { display: none; }
    * { font-family: 'Inter', sans-serif; }
    @media (prefers-reduced-motion: reduce) { .animate-pulse { animation: none !important; } }
  </style>
  <script>
    tailwind.config = {
      theme: { 
        extend: { 
          colors: { 
            dark: { 900:'#0a0a0a', 800:'#1a1a1a', 700:'#2a2a2a', 600:'#3a3a3a' }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-dark-900 text-white overflow-x-hidden">

<!-- Status Bar -->
<div id="status-bar" class="flex justify-between items-center px-4 py-2 bg-dark-800 text-xs text-gray-300">
  <div class="flex items-center space-x-1">
    <div class="w-1 h-1 bg-white rounded-full"></div>
    <div class="w-1 h-1 bg-white rounded-full"></div>
    <div class="w-1 h-1 bg-gray-600 rounded-full"></div>
    <span class="ml-2">Xiaomi Pad</span>
  </div>
  <div class="font-medium">9:41</div>
  <div class="flex items-center space-x-1">
    <i class="fa-solid fa-signal text-xs"></i>
    <i class="fa-solid fa-wifi text-xs"></i>
    <div class="w-6 h-3 border border-white rounded-sm"><div class="w-4 h-2 bg-white rounded-sm m-0.5"></div></div>
  </div>
</div>

<!-- App Header -->
<div id="app-header" class="flex items-center justify-between px-6 py-4 bg-dark-800 border-b border-dark-600">
  <div class="flex items-center space-x-3">
    <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
      <i class="fa-solid fa-microphone text-white text-sm"></i>
    </div>
    <div>
      <h1 class="text-lg font-semibold text-white">Whisper Transcription</h1>
      <p class="text-xs text-gray-400">Step 1: Select Video Files</p>
    </div>
  </div>
  <div class="flex items-center space-x-3">
    <div class="flex items-center space-x-2">
      <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
      <span class="text-sm text-blue-400 font-medium">Ready</span>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="px-6 py-6 pb-24">
  
  <!-- Welcome Card -->
  <div class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl p-6 mb-6 border border-dark-600">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold text-white">Select Video Files</h2>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-white rounded-full"></div>
        <span class="text-sm text-white font-medium">Step 1/3</span>
      </div>
    </div>
    <p class="text-gray-100 mb-4">Choose one or more video files to transcribe using Whisper AI. Supported formats: MP4, AVI, MOV, MKV, WebM</p>
    <div class="flex items-center space-x-4">
      <div class="flex items-center space-x-2">
        <i class="fa-solid fa-video text-white"></i>
        <span class="text-sm text-gray-100">Video Files</span>
      </div>
      <div class="flex items-center space-x-2">
        <i class="fa-solid fa-microchip text-white"></i>
        <span class="text-sm text-gray-100">On-Device Processing</span>
      </div>
    </div>
  </div>

  <!-- File Selection Section -->
  <div class="bg-dark-700 rounded-2xl p-6 border border-dark-600 mb-6">
    <h3 class="text-lg font-semibold text-white mb-6">File Selection</h3>

    <!-- Browse Button -->
    <button id="browse-files-btn"
            class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-semibold py-4 px-6 rounded-xl flex items-center justify-center space-x-3 transition-all duration-200 mb-6">
      <i class="fa-solid fa-folder-open text-xl"></i>
      <span class="text-lg">Browse Video Files</span>
    </button>
    
    <!-- Preset Selection -->
    <div class="bg-dark-600 rounded-xl p-4 mb-6">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center space-x-3">
          <i class="fa-solid fa-sliders text-yellow-300"></i>
          <span class="text-sm text-gray-300">Processing Preset</span>
        </div>
        <div class="flex items-center space-x-2">
          <button id="preset-single" class="text-xs px-3 py-1 rounded-lg bg-purple-600 text-white font-medium ring-1 ring-purple-500">Single</button>
          <button id="preset-accuracy" class="text-xs px-3 py-1 rounded-lg bg-dark-700 border border-dark-600 text-gray-300">Accuracy</button>
        </div>
      </div>
      <div class="text-xs text-gray-400">
        <p><strong>Single:</strong> Fast processing, good for most videos</p>
        <p><strong>Accuracy:</strong> Slower processing, higher accuracy</p>
      </div>
    </div>

    <!-- Model Selection -->
    <div class="bg-dark-600 rounded-xl p-4 mb-6">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center space-x-3">
          <i class="fa-solid fa-brain text-blue-300"></i>
          <span class="text-sm text-gray-300">AI Model</span>
        </div>
        <button id="pick-model-btn" class="text-xs px-3 py-1 rounded bg-dark-700 border border-dark-600 hover:border-purple-600">Change</button>
      </div>
      <div class="text-xs text-gray-400">
        <p id="selected-model">ggml-small.en.bin (Default)</p>
        <p>Optimized for English transcription</p>
      </div>
    </div>
                
    <!-- Selected Files Summary -->
    <div id="selected-files-summary" class="bg-dark-800 rounded-xl p-4 border border-dark-600 mb-6" style="display: none;">
      <div class="flex justify-between items-center mb-3">
        <span class="text-gray-400 font-medium">Selected Files:</span>
        <div class="flex items-center space-x-2">
          <span id="file-count" class="text-purple-300 font-bold text-lg">0</span>
          <button id="clear-selection-btn" class="text-red-400 hover:text-red-300 text-xs px-2 py-1 rounded border border-red-600 hover:border-red-500">Clear All</button>
        </div>
      </div>
      <div id="files-list" class="space-y-2"></div>
    </div>

    <!-- Process Button -->
    <button id="process-files-btn"
            class="w-full bg-dark-600 text-gray-400 font-semibold py-4 px-6 rounded-xl mb-4 flex items-center justify-center space-x-3 cursor-not-allowed opacity-60"
            disabled>
      <i class="fa-solid fa-play text-xl"></i>
      <span class="text-lg">Start Processing</span>
    </button>

    <!-- Status Information -->
    <div id="status-info" class="bg-dark-800 rounded-xl p-4 border border-dark-600"
         role="status" aria-live="polite" aria-busy="false">
      <div class="flex items-center space-x-3">
        <div class="w-3 h-3 bg-gray-500 rounded-full"></div>
        <div>
          <p class="text-sm font-medium text-white">Ready to Select Files</p>
          <p class="text-xs text-gray-400">Choose video files to begin transcription</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Resource Monitor -->
  <div class="bg-gradient-to-br from-dark-700 to-dark-600 rounded-2xl p-4 border border-dark-600 mb-6">
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        <h3 class="text-sm font-semibold text-white">Xiaomi Resource Usage</h3>
      </div>
      <button id="refresh-stats" class="text-xs px-2 py-1 rounded bg-dark-600 border border-dark-500 hover:border-purple-600">Refresh</button>
    </div>
    <div id="stats-body" class="grid grid-cols-2 gap-3 text-xs text-gray-300">
      <div class="bg-dark-700 rounded-lg p-2 border border-dark-600"><span class="text-gray-400">CPU</span> <span class="float-right text-white" id="stat-cpu">—</span>%</div>
      <div class="bg-dark-700 rounded-lg p-2 border border-dark-600"><span class="text-gray-400">Memory</span> <span class="float-right text-white" id="stat-mem">—</span>%</div>
      <div class="bg-dark-700 rounded-lg p-2 border border-dark-600"><span class="text-gray-400">Battery</span> <span class="float-right text-white" id="stat-bat">—</span>%</div>
      <div class="bg-dark-700 rounded-lg p-2 border border-dark-600"><span class="text-gray-400">Temp</span> <span class="float-right text-white" id="stat-temp">—</span>°C</div>
    </div>
  </div>
</div>

<!-- Bottom Navigation -->
<div id="bottom-navigation" class="fixed bottom-0 left-0 right-0 bg-dark-800 border-t border-dark-600 px-6 py-3 pb-[env(safe-area-inset-bottom)]">
  <div class="flex items-center justify-between">
    <div class="flex items-center space-x-6">
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
        <span class="text-xs text-purple-400 font-medium">Select</span>
      </div>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-gray-600 rounded-full"></div>
        <span class="text-xs text-gray-500">Processing</span>
      </div>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-gray-600 rounded-full"></div>
        <span class="text-xs text-gray-500">Results</span>
      </div>
    </div>
    <div class="text-xs text-gray-500">Whisper File Selection</div>
  </div>
</div>

<script>
/* ===================== WHISPER: FILE SELECTION PAGE ===================== */

(() => {
  // State management
  const state = {
    selectedFiles: [],
    selectedPreset: 'Single',
    selectedModel: 'ggml-small.en.bin (Default)',
    isProcessing: false
  };

  // DOM Elements
  const browseFilesBtn = document.getElementById('browse-files-btn');
  const processFilesBtn = document.getElementById('process-files-btn');
  const selectedFilesSummary = document.getElementById('selected-files-summary');
  const fileCountElement = document.getElementById('file-count');
  const filesListElement = document.getElementById('files-list');
  const clearSelectionBtn = document.getElementById('clear-selection-btn');
  const presetSingleBtn = document.getElementById('preset-single');
  const presetAccuracyBtn = document.getElementById('preset-accuracy');
  const pickModelBtn = document.getElementById('pick-model-btn');
  const selectedModelElement = document.getElementById('selected-model');
  const statusInfo = document.getElementById('status-info');
  const statusDot = document.querySelector('#status-info .w-3');
  const statusText = document.querySelector('#status-info .text-xs');
  const refreshStatsBtn = document.getElementById('refresh-stats');

  // Bridge contract (provided by Android WebView)
  const hasBridge = typeof window.WhisperBridge !== 'undefined';
  const bridge = hasBridge ? {
    async openFilePicker() { return window.WhisperBridge.openFilePicker(); },
    async getAllVideoFiles() { return window.WhisperBridge.getAllVideoFiles(); },
    async runBatch(args) { 
      const batchId = window.WhisperBridge.runBatch(JSON.stringify(args));
      return batchId;
    },
    async openStep2() { 
      if (window.WhisperBridge.openWhisperStep2) {
        return window.WhisperBridge.openWhisperStep2();
      }
    },
    async getResourceStats() { 
      if (window.WhisperBridge.getResourceStats) {
        return window.WhisperBridge.getResourceStats();
      }
    },
    async pickModel() {
      if (window.WhisperBridge.pickModel) {
        return window.WhisperBridge.pickModel();
      }
    }
  } : mockBridge();

  function mockBridge() {
    return {
      async openFilePicker() { 
        console.log('Mock: Opening file picker');
        return 'file_picker_launched'; 
      },
      async getAllVideoFiles() { 
        return JSON.stringify({
          files: [
            { name: 'video1.mp4', size: 15728640, uri: 'file:///sdcard/video1.mp4', format: 'mp4' },
            { name: 'movie2.avi', size: 20971520, uri: 'file:///sdcard/movie2.avi', format: 'avi' }
          ],
          count: 2
        });
      },
      async runBatch() { 
        console.log('Mock: Starting batch processing');
        return 'batch-mock-123';
      },
      async openStep2() { 
        console.log('Mock: Opening processing page');
        return 'ok';
      },
      async getResourceStats() { 
        return JSON.stringify({
          memory: Math.floor(Math.random() * 50) + 20,
          cpu: Math.floor(Math.random() * 30) + 10,
          battery: Math.floor(Math.random() * 40) + 60,
          temperature: Math.floor(Math.random() * 10) + 35
        });
      },
      async pickModel() {
        console.log('Mock: Picking model');
        return '/sdcard/Models/ggml-small.en.bin';
      }
    };
  }

  // Utility Functions
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  function setStatus(message, type = 'info', busy = false) {
    statusText.textContent = message;
    statusInfo.setAttribute('aria-busy', String(busy));
    
    // Update status dot color
    const colors = {
      info: 'bg-gray-500',
      success: 'bg-green-500',
      warning: 'bg-yellow-500',
      error: 'bg-red-500',
      processing: 'bg-purple-500'
    };
    statusDot.className = `w-3 h-3 rounded-full ${colors[type] || colors.info} ${type === 'processing' ? 'animate-pulse' : ''}`;
  }

  function showToast(message, isError = false) {
    console.log(isError ? 'ERROR:' : 'SUCCESS:', message);
    // In a real app, you'd show a toast notification
  }

  // Update process button state
  function updateProcessButtonState() {
    const hasFiles = state.selectedFiles.length > 0;
    processFilesBtn.disabled = !hasFiles || state.isProcessing;
    
    if (state.isProcessing) {
      processFilesBtn.className = 'w-full bg-purple-600 text-white font-semibold py-4 px-6 rounded-xl mb-4 flex items-center justify-center space-x-3 opacity-60';
      processFilesBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-xl"></i><span class="text-lg">Processing...</span>';
    } else if (hasFiles) {
      processFilesBtn.className = 'w-full bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-semibold py-4 px-6 rounded-xl mb-4 flex items-center justify-center space-x-3 transition-all duration-200 active:scale-95';
      processFilesBtn.innerHTML = '<i class="fa-solid fa-play text-xl"></i><span class="text-lg">Start Processing</span>';
    } else {
      processFilesBtn.className = 'w-full bg-dark-600 text-gray-400 font-semibold py-4 px-6 rounded-xl mb-4 flex items-center justify-center space-x-3 cursor-not-allowed opacity-60';
      processFilesBtn.innerHTML = '<i class="fa-solid fa-play text-xl"></i><span class="text-lg">Start Processing</span>';
    }
  }

  // Update selected files display
  function renderSelectedFilesList() {
    if (state.selectedFiles.length === 0) {
      selectedFilesSummary.style.display = 'none';
      return;
    }
    
    selectedFilesSummary.style.display = 'block';
    fileCountElement.textContent = state.selectedFiles.length;
    
    filesListElement.innerHTML = '';
    state.selectedFiles.forEach((file, index) => {
      const fileDiv = document.createElement('div');
      fileDiv.className = 'flex items-center justify-between bg-dark-700 rounded-lg p-3';
      fileDiv.innerHTML = `
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-purple-500/20 rounded-lg flex items-center justify-center">
            <i class="fa-solid fa-video text-purple-400 text-sm"></i>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm text-white font-medium truncate">${file.name}</p>
            <p class="text-xs text-gray-400">${formatFileSize(file.size)} • ${file.format.toUpperCase()}</p>
          </div>
        </div>
        <button class="text-gray-400 hover:text-red-400 transition-colors remove-file-btn" data-index="${index}">
          <i class="fa-solid fa-times text-sm"></i>
        </button>
      `;
      filesListElement.appendChild(fileDiv);
    });
    
    // Add remove file event listeners
    filesListElement.querySelectorAll('.remove-file-btn').forEach(btn => {
      btn.onclick = () => {
        const index = parseInt(btn.dataset.index);
        state.selectedFiles.splice(index, 1);
        renderSelectedFilesList();
        updateProcessButtonState();
        setStatus(`${state.selectedFiles.length} files selected`, 'success', false);
        showToast('File removed');
      };
    });
  }

  // Update preset selection
  function updatePresetSelection(preset) {
    state.selectedPreset = preset;
    [presetSingleBtn, presetAccuracyBtn].forEach(btn => {
      btn.classList.remove('ring-1', 'ring-purple-500', 'text-white', 'bg-purple-600');
      btn.classList.add('bg-dark-700', 'border', 'border-dark-600', 'text-gray-300');
    });
    
    const activeButton = preset === 'Single' ? presetSingleBtn : presetAccuracyBtn;
    activeButton.classList.remove('bg-dark-700', 'border', 'border-dark-600', 'text-gray-300');
    activeButton.classList.add('ring-1', 'ring-purple-500', 'text-white', 'bg-purple-600');
  }

  // Event Handlers
  browseFilesBtn.onclick = async () => {
    try {
      setStatus('Opening file browser...', 'processing', true);
      
      const pickerResult = await bridge.openFilePicker();
      console.log('File picker result:', pickerResult);
      
      if (pickerResult === 'file_picker_launched') {
        setStatus('File picker opened - select your video files', 'success', false);
        showToast('File picker opened - select your video files');
      } else {
        setStatus('File picker failed, trying local scan...', 'warning', true);
        
        const result = await bridge.getAllVideoFiles();
        const data = JSON.parse(result);
        
        if (data.files && data.files.length > 0) {
          state.selectedFiles = [...state.selectedFiles, ...data.files];
          renderSelectedFilesList();
          updateProcessButtonState();
          
          setStatus(`Found ${data.files.length} video files`, 'success', false);
          showToast(`Found ${data.files.length} video files in local storage`);
        } else {
          setStatus('No video files found', 'warning', false);
          showToast('No video files found in common directories');
        }
      }
    } catch (e) {
      setStatus('File browser failed', 'error', false);
      showToast(`File browser failed: ${String(e)}`, true);
    }
  };

  // File selection handler (called from Android bridge)
  window.handleFileSelection = (jsonResponse) => {
    try {
      console.log('handleFileSelection called with:', jsonResponse);
      const data = JSON.parse(jsonResponse);
      
      if (data.success && data.files && data.files.length > 0) {
        state.selectedFiles = [...state.selectedFiles, ...data.files];
        renderSelectedFilesList();
        updateProcessButtonState();
        
        setStatus(`${data.files.length} files selected from picker`, 'success', false);
        showToast(`Selected ${data.files.length} files from picker`);
      } else if (data.error) {
        setStatus('File selection failed', 'error', false);
        showToast(`Selection failed: ${data.error}`, true);
      } else {
        setStatus('No files selected', 'warning', false);
        showToast('No files selected');
      }
    } catch (e) {
      console.error('Exception in handleFileSelection:', e);
      setStatus('File selection error', 'error', false);
      showToast(`Selection error: ${String(e)}`, true);
    }
  };

  processFilesBtn.onclick = async () => {
    if (state.selectedFiles.length === 0) {
      showToast('Please select at least one video file', true);
      return;
    }
    
    try {
      state.isProcessing = true;
      updateProcessButtonState();
      setStatus('Starting processing...', 'processing', true);
      
      const uris = state.selectedFiles.map(file => file.uri);
      
      const batchId = await bridge.runBatch({
        uris: uris,
        preset: state.selectedPreset,
        modelPath: state.selectedModel
      });
      
      setStatus(`Processing ${state.selectedFiles.length} files...`, 'processing', true);
      showToast(`Started processing ${state.selectedFiles.length} files (Batch: ${batchId})`);
      
      // Navigate to Step 2 after successful submission
      setTimeout(async () => {
        try {
          await bridge.openStep2();
        } catch (err) {
          console.error('Navigation error:', err);
          setStatus('Processing started - navigate to Processing', 'success', false);
        }
      }, 1000);
      
    } catch (e) {
      state.isProcessing = false;
      updateProcessButtonState();
      setStatus('Processing failed', 'error', false);
      showToast(`Processing failed: ${String(e)}`, true);
    }
  };

  clearSelectionBtn.onclick = () => {
    state.selectedFiles = [];
    renderSelectedFilesList();
    updateProcessButtonState();
    setStatus('Selection cleared', 'warning', false);
    showToast('Selection cleared');
  };

  // Preset buttons
  presetSingleBtn.onclick = () => updatePresetSelection('Single');
  presetAccuracyBtn.onclick = () => updatePresetSelection('Accuracy');

  // Model picker
  pickModelBtn.onclick = async () => {
    try {
      const modelPath = await bridge.pickModel();
      if (modelPath) {
        state.selectedModel = modelPath;
        selectedModelElement.textContent = modelPath;
        showToast('Model selected');
      }
    } catch (err) {
      showToast(`Model pick failed: ${String(err)}`, true);
    }
  };

  // Resource monitoring
  async function updateResourceStats() {
    try {
      if (!hasBridge || !window.WhisperBridge.getResourceStats) return;
      const stats = await bridge.getResourceStats();
      const data = JSON.parse(stats);
      
      document.getElementById('stat-cpu').textContent = data.cpu ? data.cpu.toFixed(1) : '—';
      document.getElementById('stat-mem').textContent = data.memory || '—';
      document.getElementById('stat-bat').textContent = data.battery || '—';
      document.getElementById('stat-temp').textContent = data.temperature ? data.temperature.toFixed(1) : '—';
    } catch (e) {
      console.error('Resource stats error:', e);
    }
  }

  refreshStatsBtn.onclick = updateResourceStats;

  // Initialize
  updatePresetSelection('Single');
  updateProcessButtonState();
  renderSelectedFilesList();
  updateResourceStats();

  // Auto-refresh resource stats
  if (hasBridge) {
    setInterval(updateResourceStats, 3000);
  }

  console.log('Whisper File Selection initialized');

})();
</script>

</body>
</html>
