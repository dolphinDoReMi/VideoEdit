<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
  <script> window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
      safelist: [
        'bg-yellow-500','bg-blue-500','bg-purple-500','bg-green-500','bg-gray-500',
        'bg-green-500/20','bg-blue-500/20','text-green-300','text-blue-300'
      ],
            theme: {
                extend: {
                    colors: {
            dark: { 900:'#0a0a0a', 800:'#1a1a1a', 700:'#2a2a2a', 600:'#3a3a3a' }
                    }
                }
            }
        }
    </script>
  <style>
    ::-webkit-scrollbar { display: none; }
    * { font-family: 'Inter', sans-serif; }
    @media (prefers-reduced-motion: reduce) { .animate-pulse { animation: none !important; } }
  </style>
</head>
<body class="bg-dark-900 text-white overflow-x-hidden">

<!-- Status Bar -->
<div id="status-bar" class="flex justify-between items-center px-4 py-2 bg-dark-800 text-xs text-gray-300">
    <div class="flex items-center space-x-1">
        <div class="w-1 h-1 bg-white rounded-full"></div>
        <div class="w-1 h-1 bg-white rounded-full"></div>
        <div class="w-1 h-1 bg-gray-600 rounded-full"></div>
        <span class="ml-2">Verizon</span>
    </div>
    <div class="font-medium">9:41</div>
    <div class="flex items-center space-x-1">
        <i class="fa-solid fa-signal text-xs"></i>
        <i class="fa-solid fa-wifi text-xs"></i>
        <div class="w-6 h-3 border border-white rounded-sm">
            <div class="w-4 h-2 bg-white rounded-sm m-0.5"></div>
        </div>
    </div>
</div>

<!-- App Header -->
<div id="app-header" class="flex items-center justify-between px-6 py-4 bg-dark-800 border-b border-dark-600">
    <div class="flex items-center space-x-3">
        <button class="w-8 h-8 bg-dark-600 rounded-full flex items-center justify-center">
      <i class="fa-solid fa-arrow-left text-gray-300 text-sm"></i>
    </button>
    <div>
      <h1 class="text-lg font-semibold text-white">Whisper Processing</h1>
      <p class="text-xs text-gray-400">Batch Video File Selection</p>
    </div>
</div>
  <div class="flex items-center space-x-3">
      <div class="flex items-center space-x-2">
      <div class="w-2 h-2 bg-green-500 rounded-full"></div>
        <span class="text-sm text-green-400 font-medium">Ready</span>
            </div>
            </div>
            </div>

<!-- Main Content -->
<div class="px-6 py-6 pb-24">
  
  <!-- File Selection Section -->
  <div class="bg-dark-700 rounded-2xl p-6 border border-dark-600 mb-6">
    <h3 class="text-lg font-semibold text-white mb-6">Select Video Files for Processing</h3>

    <!-- File Selection Button -->
    <div class="mb-6">
      <button id="select-video-files-btn"
              class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-semibold py-4 px-6 rounded-xl flex items-center justify-center space-x-3 transition-all duration-200 mb-4">
        <i class="fa-solid fa-folder-open text-xl"></i>
        <span class="text-lg">Select Video Files</span>
      </button>
      
      <button id="open-file-picker-btn"
              class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-semibold py-4 px-6 rounded-xl flex items-center justify-center space-x-3 transition-all duration-200 mb-4">
        <i class="fa-solid fa-photo-film text-xl"></i>
        <span class="text-lg">Browse Local Media</span>
      </button>
      
      <!-- Supported Formats Info -->
      <div class="bg-dark-600 rounded-lg p-3 mb-4">
        <div class="text-xs text-gray-400 mb-2">Supported Formats:</div>
        <div class="flex flex-wrap gap-2">
          <span class="text-xs px-2 py-1 bg-purple-600/20 text-purple-300 rounded">MP4</span>
          <span class="text-xs px-2 py-1 bg-blue-600/20 text-blue-300 rounded">AVI</span>
          <span class="text-xs px-2 py-1 bg-green-600/20 text-green-300 rounded">MOV</span>
          <span class="text-xs px-2 py-1 bg-yellow-600/20 text-yellow-300 rounded">MKV</span>
          <span class="text-xs px-2 py-1 bg-red-600/20 text-red-300 rounded">WEBM</span>
          <span class="text-xs px-2 py-1 bg-indigo-600/20 text-indigo-300 rounded">WMV</span>
          <span class="text-xs px-2 py-1 bg-pink-600/20 text-pink-300 rounded">FLV</span>
        </div>
            </div>
      
      <!-- Quick Selection Options -->
      <div class="grid grid-cols-2 gap-3 mb-4">
        <button id="select-all-videos-btn"
                class="bg-dark-600 hover:bg-dark-600/80 text-gray-200 font-medium py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-200">
          <i class="fa-solid fa-check-double text-sm text-green-300"></i>
          <span>Select All Videos</span>
        </button>
        
        <button id="clear-selection-btn"
                class="bg-dark-600 hover:bg-dark-600/80 text-gray-200 font-medium py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-200">
          <i class="fa-solid fa-trash text-sm text-red-300"></i>
          <span>Clear All</span>
        </button>
      </div>
    </div>

    <!-- Selected Files List -->
    <div id="selected-files-list" class="space-y-2 mb-6" style="display: none;">
      <div class="text-xs text-gray-400 mb-2">Selected Files:</div>
      <div id="files-container" class="space-y-2"></div>
            </div>

    <!-- Processing Options -->
    <div class="bg-dark-600 rounded-xl p-4 border border-dark-500 mb-4">
      <h4 class="text-sm font-medium text-white mb-3">Processing Options</h4>
      
      <!-- Preset Selection -->
      <div class="mb-3">
        <label class="text-xs text-gray-400 mb-2 block">Processing Preset</label>
        <div class="flex items-center space-x-2">
          <button id="preset-single" class="text-xs px-3 py-2 rounded-lg bg-purple-600 text-white font-medium">Fast</button>
          <button id="preset-accuracy" class="text-xs px-3 py-2 rounded-lg bg-dark-700 border border-dark-600 text-gray-300">Accurate</button>
        </div>
            </div>
      
      <!-- Model Selection -->
      <div class="mb-3">
        <label class="text-xs text-gray-400 mb-2 block">Model</label>
        <div class="text-xs text-gray-300 bg-dark-700 rounded-lg px-3 py-2">
          <span id="sel-model">ggml-small.en.bin (Default)</span>
        </div>
    </div>
</div>

    <!-- Selected Files Summary -->
    <div id="selection-summary" class="bg-dark-800 rounded-xl p-3 border border-dark-600 mb-4 text-xs text-gray-300" style="display: none;">
      <div class="flex justify-between items-center">
        <div>
          <span class="text-gray-400">Files:</span> <span id="file-count">0</span>
          <span class="text-gray-400 ml-4">Total Size:</span> <span id="total-size">0 MB</span>
                    </div>
        <div>
          <span class="text-gray-400">Preset:</span> <span id="sel-preset">Fast</span>
        </div>
                    </div>
                </div>
                
    <!-- Process Button -->
    <button id="process-files-btn"
            class="w-full bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-semibold py-4 px-6 rounded-xl mb-4 flex items-center justify-center space-x-3 cursor-not-allowed opacity-60"
            disabled>
      <i class="fa-solid fa-play text-xl"></i>
      <span class="text-lg">Process Selected Files</span>
    </button>

    <!-- Error Display Section -->
    <div id="error-display" class="bg-red-900/20 border border-red-600 rounded-xl p-4 mb-4" style="display: none;">
      <div class="flex items-start space-x-3">
        <div class="w-5 h-5 bg-red-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
          <i class="fa-solid fa-exclamation text-white text-xs"></i>
        </div>
        <div class="flex-1">
          <h4 class="text-sm font-medium text-red-300 mb-1">File Selection Error</h4>
          <p id="error-message" class="text-xs text-red-200 mb-2"></p>
          <div id="error-details" class="text-xs text-red-300/80"></div>
        </div>
        <button id="dismiss-error" class="text-red-400 hover:text-red-300 transition-colors">
          <i class="fa-solid fa-times text-sm"></i>
        </button>
      </div>
    </div>

    <!-- Warning Display Section -->
    <div id="warning-display" class="bg-yellow-900/20 border border-yellow-600 rounded-xl p-4 mb-4" style="display: none;">
      <div class="flex items-start space-x-3">
        <div class="w-5 h-5 bg-yellow-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
          <i class="fa-solid fa-triangle-exclamation text-white text-xs"></i>
        </div>
        <div class="flex-1">
          <h4 class="text-sm font-medium text-yellow-300 mb-1">File Selection Warnings</h4>
          <div id="warning-list" class="text-xs text-yellow-200"></div>
        </div>
        <button id="dismiss-warning" class="text-yellow-400 hover:text-yellow-300 transition-colors">
          <i class="fa-solid fa-times text-sm"></i>
        </button>
      </div>
    </div>

    <!-- Status Information -->
    <div id="analysis-status" class="bg-dark-800 rounded-xl p-4 border border-dark-600"
         role="status" aria-live="polite" aria-busy="false">
      <div class="flex items-center space-x-3">
        <div class="w-3 h-3 bg-gray-500 rounded-full"></div>
                    <div>
          <p class="text-sm font-medium text-white">Ready</p>
          <p class="text-xs text-gray-400">Select MP4 files to process</p>
                </div>
        </div>
            </div>
        </div>
        
  <!-- Recent Jobs -->
  <div id="recent-projects" class="mb-8">
        <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-white">Recent Jobs</h3>
            <div class="flex items-center space-x-2">
      <button id="refresh-runs" class="text-purple-400 text-sm font-medium">Refresh</button>
    </div>
  </div>

  <div id="runs-list" class="space-y-3">
      <div class="text-sm text-gray-500">No recent jobs.</div>
        </div>
    </div>
</div>

<!-- Bottom Navigation -->
<div id="bottom-navigation" class="fixed bottom-0 left-0 right-0 bg-dark-800 border-t border-dark-600 px-6 py-3 pb-[env(safe-area-inset-bottom)]">
  <div class="flex items-center justify-between">
    <div class="flex items-center space-x-6">
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
        <span class="text-xs text-purple-400 font-medium">Step 1</span>
      </div>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-gray-600 rounded-full"></div>
        <span class="text-xs text-gray-500">Step 2</span>
      </div>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-gray-600 rounded-full"></div>
        <span class="text-xs text-gray-500">Step 3</span>
      </div>
    </div>
    <div class="text-xs text-gray-500">Whisper Processing</div>
    </div>
</div>

<script>
/* ===================== WHISPER STEP 1: BATCH VIDEO PROCESSING ===================== */

// DOM Elements
const selectVideoBtn = document.getElementById('select-video-files-btn');
const openFilePickerBtn = document.getElementById('open-file-picker-btn');
const selectAllBtn = document.getElementById('select-all-videos-btn');
const clearBtn = document.getElementById('clear-selection-btn');
const processBtn = document.getElementById('process-files-btn');

// Debug: Check if buttons are found
console.log('selectVideoBtn:', selectVideoBtn);
console.log('openFilePickerBtn:', openFilePickerBtn);
const filesList = document.getElementById('selected-files-list');
const filesContainer = document.getElementById('files-container');
const selectionSummary = document.getElementById('selection-summary');
const fileCount = document.getElementById('file-count');
const totalSize = document.getElementById('total-size');
const selPreset = document.getElementById('sel-preset');
const statusDiv = document.getElementById('analysis-status');
  const btnPresetSingle = document.getElementById('preset-single');
  const btnPresetAcc = document.getElementById('preset-accuracy');
  const runsList = document.getElementById('runs-list');
  const btnRefresh = document.getElementById('refresh-runs');

// State
let selectedFiles = [];
let selectedPreset = 'Fast';
let selectedModel = 'ggml-small.en.bin (Default)';

  /* ---- Bridge contract (provided by Android WebView) ----
   window.AndroidWhisper.pickUri() -> String uri (content://… or file://…)
   window.AndroidWhisper.pickModel() -> String path
   window.AndroidWhisper.run(json) -> String jobId
   window.AndroidWhisper.listRuns() -> JSON string
     All may throw on error.
*/

// Mock bridge for browser testing
const mockBridge = {
  async pickUri() {
    console.log('Mock: Picking video URI');
    // Return a mock video file
    return 'file:///sdcard/video_v1_long.mp4';
  },
  
  async pickModel() {
    console.log('Mock: Picking model');
    return '/sdcard/Models/ggml-small.en.bin';
  },
  
  async run(params) {
    console.log('Mock: Running with params:', params);
    return 'mock-job-' + Date.now();
  },
  
  async getAllVideoFiles() {
    console.log('Mock: Getting all video files');
    // Return mock data with various formats
    return JSON.stringify({
      files: [
        { name: 'video1.mp4', size: 15728640, uri: 'file:///sdcard/video1.mp4', format: 'mp4' },
        { name: 'movie2.avi', size: 20971520, uri: 'file:///sdcard/movie2.avi', format: 'avi' },
        { name: 'clip3.mov', size: 12582912, uri: 'file:///sdcard/clip3.mov', format: 'mov' },
        { name: 'film4.mkv', size: 31457280, uri: 'file:///sdcard/film4.mkv', format: 'mkv' },
        { name: 'web5.webm', size: 8388608, uri: 'file:///sdcard/web5.webm', format: 'webm' },
        { name: 'movie6.wmv', size: 25165824, uri: 'file:///sdcard/Movies/movie6.wmv', format: 'wmv' },
        { name: 'clip7.flv', size: 10485760, uri: 'file:///sdcard/DCIM/Camera/clip7.flv', format: 'flv' }
      ],
      count: 7
    });
  },
};

// Use real bridge if available, otherwise mock
const bridge = window.WhisperBridge || mockBridge;

// Utility functions
function setStatus(message, color = 'gray', busy = false) {
  const statusDot = statusDiv.querySelector('.w-3');
  const statusText = statusDiv.querySelector('.text-sm');
  const statusSubtext = statusDiv.querySelector('.text-xs');
  
  statusDot.className = `w-3 h-3 bg-${color}-500 rounded-full ${busy ? 'animate-pulse' : ''}`;
  statusText.textContent = message;
  statusSubtext.textContent = busy ? 'Processing...' : 'Ready';
}

function toast(message, isError = false) {
  console.log(isError ? 'ERROR:' : 'INFO:', message);
  // In a real app, you'd show a toast notification
}

function getFileIcon(format) {
  const icons = {
    'mp4': 'fa-solid fa-video text-purple-400',
    'avi': 'fa-solid fa-video text-blue-400',
    'mov': 'fa-solid fa-video text-green-400',
    'mkv': 'fa-solid fa-video text-yellow-400',
    'webm': 'fa-solid fa-video text-red-400',
    'wmv': 'fa-solid fa-video text-indigo-400',
    'flv': 'fa-solid fa-video text-pink-400'
  };
  return icons[format.toLowerCase()] || 'fa-solid fa-video text-gray-400';
}

function getFileFormatColor(format) {
  const colors = {
    'mp4': 'purple',
    'avi': 'blue',
    'mov': 'green',
    'mkv': 'yellow',
    'webm': 'red',
    'wmv': 'indigo',
    'flv': 'pink'
  };
  return colors[format.toLowerCase()] || 'gray';
}

function updateFileList() {
  if (selectedFiles.length === 0) {
    filesList.style.display = 'none';
    selectionSummary.style.display = 'none';
    processBtn.disabled = true;
    processBtn.classList.add('cursor-not-allowed', 'opacity-60');
    return;
  }
  
  filesList.style.display = 'block';
  selectionSummary.style.display = 'block';
  processBtn.disabled = false;
  processBtn.classList.remove('cursor-not-allowed', 'opacity-60');
  
  // Update file count and total size
  fileCount.textContent = selectedFiles.length;
  const totalBytes = selectedFiles.reduce((sum, file) => sum + (file.size || 0), 0);
  totalSize.textContent = formatFileSize(totalBytes);
  
  // Update files container
  filesContainer.innerHTML = '';
  selectedFiles.forEach((file, index) => {
    const fileExtension = file.name.split('.').pop().toLowerCase();
    const fileIcon = getFileIcon(fileExtension);
    const formatColor = getFileFormatColor(fileExtension);
    
    const fileDiv = document.createElement('div');
    fileDiv.className = 'bg-dark-700 rounded-lg p-3 border border-dark-600 flex items-center justify-between';
    fileDiv.innerHTML = `
      <div class="flex items-center space-x-3">
        <i class="${fileIcon}"></i>
        <div>
          <div class="text-sm font-medium text-white">${file.name}</div>
          <div class="flex items-center space-x-2">
            <span class="text-xs text-gray-400">${formatFileSize(file.size || 0)}</span>
            <span class="text-xs px-2 py-0.5 bg-${formatColor}-600/20 text-${formatColor}-300 rounded">${fileExtension.toUpperCase()}</span>
          </div>
        </div>
        </div>
      <button class="text-gray-400 hover:text-red-400 transition-colors remove-file-btn" data-index="${index}">
        <i class="fa-solid fa-times text-sm"></i>
      </button>
    `;
    filesContainer.appendChild(fileDiv);
  });
  
  // Add remove file event listeners
  filesContainer.querySelectorAll('.remove-file-btn').forEach(btn => {
    btn.onclick = () => {
      const index = parseInt(btn.dataset.index);
      selectedFiles.splice(index, 1);
      updateFileList();
      setStatus(`${selectedFiles.length} files selected`, 'blue', false);
      };
    });
  }

// Event handlers
openFilePickerBtn.onclick = async () => {
  console.log('Browse Local Media button clicked!');
  try {
    setStatus('Opening file picker...', 'blue', true);
    hideErrorMessages();
    
    // Launch the system file picker
    console.log('Calling bridge.openFilePicker()...');
    const result = await bridge.openFilePicker();
    console.log('File picker result:', result);
    
    if (result === 'file_picker_launched') {
      setStatus('File picker opened', 'green', false);
      toast('File picker opened - select your video files');
    } else if (result.startsWith('error:')) {
      const errorType = result.substring(6); // Remove 'error:' prefix
      showFilePickerError(errorType);
      setStatus('File picker error', 'red', false);
    } else {
      setStatus('File picker error', 'red', false);
      toast(`File picker error: ${result}`, true);
    }
  } catch (e) {
    console.error('File picker error:', e);
    setStatus('File picker failed', 'red', false);
    showError('File picker failed', `Unexpected error: ${String(e)}`);
    toast(`File picker failed: ${String(e)}`, true);
  }
};

selectVideoBtn.onclick = async () => {
  try {
    setStatus('Selecting video files...', 'blue', true);
    hideErrorMessages();
    
    // Get video files from the bridge
    const result = await bridge.getAllVideoFiles();
    const data = JSON.parse(result);
    
    if (data.error) {
      showError('Video File Detection Error', data.error, 'Please check storage permissions and try again.');
      throw new Error(data.error);
    }
    
    if (!data.files || data.files.length === 0) {
      showError('No Video Files Found', 'No video files were found in common directories.', 'Please ensure video files exist in DCIM/Camera, Movies, or Download folders.');
      setStatus('No video files found', 'yellow', false);
      return;
    }
    
    // Add files to selection
    selectedFiles = [...selectedFiles, ...data.files];
    updateFileList();
    
    setStatus(`${selectedFiles.length} video files selected`, 'green', false);
    toast(`Selected ${data.files.length} video files`);
    
  } catch (e) {
    setStatus('File selection failed', 'red', false);
    showError('File Selection Failed', `Failed to detect video files: ${String(e)}`, 'Please check storage permissions and try again.');
    toast(`Selection failed: ${String(e)}`, true);
  }
};

selectAllBtn.onclick = async () => {
  try {
    setStatus('Selecting all video files...', 'blue', true);
    hideErrorMessages();
    
    // Get all video files from the bridge
    const result = await bridge.getAllVideoFiles();
    const data = JSON.parse(result);
    
    if (data.error) {
      showError('Video File Detection Error', data.error, 'Please check storage permissions and try again.');
      throw new Error(data.error);
    }
    
    if (!data.files || data.files.length === 0) {
      showError('No Video Files Found', 'No video files were found in common directories.', 'Please ensure video files exist in DCIM/Camera, Movies, or Download folders.');
      setStatus('No video files found', 'yellow', false);
      return;
    }
    
    selectedFiles = data.files;
    updateFileList();
    
    setStatus(`${selectedFiles.length} video files selected`, 'green', false);
    toast(`Selected all ${data.files.length} video files`);
    
    } catch (e) {
    setStatus('Select all failed', 'red', false);
    showError('Select All Failed', `Failed to detect video files: ${String(e)}`, 'Please check storage permissions and try again.');
    toast(`Select all failed: ${String(e)}`, true);
  }
};

clearBtn.onclick = () => {
  selectedFiles = [];
  updateFileList();
  setStatus('Selection cleared', 'gray', false);
  toast('Selection cleared');
};

// Preset selection
btnPresetSingle.onclick = () => {
  selectedPreset = 'Fast';
  btnPresetSingle.className = 'text-xs px-3 py-2 rounded-lg bg-purple-600 text-white font-medium';
  btnPresetAcc.className = 'text-xs px-3 py-2 rounded-lg bg-dark-700 border border-dark-600 text-gray-300';
  selPreset.textContent = 'Fast';
  setStatus('Preset set to Fast', 'blue', false);
};

btnPresetAcc.onclick = () => {
  selectedPreset = 'Accurate';
  btnPresetAcc.className = 'text-xs px-3 py-2 rounded-lg bg-purple-600 text-white font-medium';
  btnPresetSingle.className = 'text-xs px-3 py-2 rounded-lg bg-dark-700 border border-dark-600 text-gray-300';
  selPreset.textContent = 'Accurate';
  setStatus('Preset set to Accurate', 'blue', false);
};

// Process files
processBtn.onclick = async () => {
  if (selectedFiles.length === 0) {
    toast('Please select at least one MP4 file', true);
      return;
  }
  
  try {
    setStatus('Processing files...', 'purple', true);
    
    // Process each file
    for (let i = 0; i < selectedFiles.length; i++) {
      const file = selectedFiles[i];
      setStatus(`Processing ${file.name} (${i + 1}/${selectedFiles.length})...`, 'purple', true);
      
      // Simulate processing
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Run whisper processing
      const jobId = await bridge.run({
        uri: file.uri,
        preset: selectedPreset,
        modelPath: selectedModel
      });
      
      toast(`Started processing: ${file.name} (Job: ${jobId})`);
    }
    
    setStatus('All files processed', 'green', false);
    toast(`Successfully processed ${selectedFiles.length} files`);
    
    // Navigate to Step 2 after successful processing
    setTimeout(() => {
      if (window.AndroidInterface && window.AndroidInterface.openWhisperProcessing) {
        window.AndroidInterface.openWhisperProcessing();
      } else {
        console.log('AndroidInterface not available, simulating navigation');
        toast('Would navigate to Step 2 (Processing)');
      }
    }, 2000);
    
  } catch (e) {
    setStatus('Processing failed', 'red', false);
    toast(`Processing failed: ${String(e)}`, true);
  }
};

// Refresh runs
btnRefresh.onclick = async () => {
  try {
    setStatus('Refreshing jobs...', 'blue', true);
    const runs = await bridge.listRuns();
    const runsData = JSON.parse(runs);
    
    if (runsData.length === 0) {
      runsList.innerHTML = '<div class="text-sm text-gray-500">No recent jobs.</div>';
    } else {
      runsList.innerHTML = runsData.map(run => `
        <div class="bg-dark-700 rounded-lg p-3 border border-dark-600">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-white">Job ${run.jobId}</span>
            <span class="text-xs text-green-400">Completed</span>
          </div>
          <div class="text-xs text-gray-400">${run.uri}</div>
        </div>
      `).join('');
    }
    
    setStatus('Jobs refreshed', 'green', false);
  } catch (e) {
    setStatus('Refresh failed', 'red', false);
    toast(`Refresh failed: ${String(e)}`, true);
  }
};

// Error handling functions
function showError(title, message, details = '') {
  const errorDisplay = document.getElementById('error-display');
  const errorMessage = document.getElementById('error-message');
  const errorDetails = document.getElementById('error-details');
  
  errorMessage.textContent = message;
  errorDetails.textContent = details;
  errorDisplay.style.display = 'block';
  
  // Auto-hide after 10 seconds
  setTimeout(() => {
    errorDisplay.style.display = 'none';
  }, 10000);
}

function showWarning(warnings) {
  const warningDisplay = document.getElementById('warning-display');
  const warningList = document.getElementById('warning-list');
  
  if (Array.isArray(warnings)) {
    warningList.innerHTML = warnings.map(w => `<div class="mb-1">• ${w}</div>`).join('');
  } else {
    warningList.innerHTML = `<div>• ${warnings}</div>`;
  }
  
  warningDisplay.style.display = 'block';
  
  // Auto-hide after 15 seconds
  setTimeout(() => {
    warningDisplay.style.display = 'none';
  }, 15000);
}

function hideErrorMessages() {
  document.getElementById('error-display').style.display = 'none';
  document.getElementById('warning-display').style.display = 'none';
}

function showFilePickerError(errorType) {
  const errorMessages = {
    'invalid_context': {
      title: 'Invalid Context',
      message: 'File picker cannot be launched from this context.',
      details: 'Please restart the app and try again.'
    },
    'no_file_picker': {
      title: 'No File Picker Available',
      message: 'No file picker application is available on this device.',
      details: 'Please install a file manager app or use a different device.'
    },
    'no_permissions': {
      title: 'Storage Permission Required',
      message: 'Storage permissions are required to access video files.',
      details: 'Please grant storage permissions in app settings and try again.'
    },
    'security_exception': {
      title: 'Security Error',
      message: 'Security restrictions prevent file picker access.',
      details: 'Please check app permissions and try again.'
    },
    'launch_failed': {
      title: 'File Picker Launch Failed',
      message: 'Unable to launch the file picker.',
      details: 'Please try again or restart the app.'
    }
  };
  
  const error = errorMessages[errorType] || {
    title: 'Unknown Error',
    message: `File picker error: ${errorType}`,
    details: 'Please try again or contact support.'
  };
  
  showError(error.title, error.message, error.details);
}

// Error dismiss handlers
document.getElementById('dismiss-error').onclick = () => {
  document.getElementById('error-display').style.display = 'none';
};

document.getElementById('dismiss-warning').onclick = () => {
  document.getElementById('warning-display').style.display = 'none';
};

// File selection handler (called from Android bridge)
window.handleFileSelection = (jsonResponse) => {
  try {
    const data = JSON.parse(jsonResponse);
    
    if (data.success && data.files && data.files.length > 0) {
      // Add selected files to the list
      selectedFiles = [...selectedFiles, ...data.files];
      updateFileList();
      
      setStatus(`${data.files.length} files selected from picker`, 'green', false);
      toast(`Selected ${data.files.length} files from picker`);
      
      // Show warnings if any
      if (data.warnings && data.warnings.length > 0) {
        showWarning(data.warnings);
      }
    } else if (data.error) {
      setStatus('File selection failed', 'red', false);
      
      // Show specific error based on error type
      if (data.errorType === 'no_selection') {
        showError('No Files Selected', 'No files were selected from the file picker.', 'Please try again and select at least one video file.');
      } else if (data.errorType === 'validation_failed') {
        showError('Invalid Files Selected', 'None of the selected files are valid for processing.', 'Please select supported video formats (MP4, AVI, MOV, MKV, WEBM, WMV, FLV).');
      } else if (data.errorType === 'processing_error') {
        showError('File Processing Error', data.error, 'Please try selecting different files.');
      } else {
        showError('File Selection Error', data.error, 'Please try again.');
      }
      
      toast(`Selection failed: ${data.error}`, true);
    } else {
      setStatus('No files selected', 'yellow', false);
      showError('No Selection', 'No files were selected.', 'Please try again and select video files.');
      toast('No files selected');
    }
  } catch (e) {
    setStatus('File selection error', 'red', false);
    showError('Selection Error', `Failed to process file selection: ${String(e)}`, 'Please try again.');
    toast(`Selection error: ${String(e)}`, true);
  }
};

// Initialize
console.log('Whisper Step 1 initialized');
setStatus('Ready to select video files', 'green', false);

</script>

</body>
</html>