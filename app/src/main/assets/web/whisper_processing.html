<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script> window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    ::-webkit-scrollbar { display: none; }
    * { font-family: 'Inter', sans-serif; }
    @media (prefers-reduced-motion: reduce) { .animate-pulse { animation: none !important; } }
    .progress-bar { transition: width 0.3s ease-in-out; }
    .processing-animation { animation: processing-pulse 2s ease-in-out infinite; }
    @keyframes processing-pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
  </style>
  <script>
    tailwind.config = {
      theme: { 
        extend: { 
          colors: { 
            dark: { 900:'#0a0a0a', 800:'#1a1a1a', 700:'#2a2a2a', 600:'#3a3a3a' }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-dark-900 text-white overflow-x-hidden">

<!-- Status Bar -->
<div id="status-bar" class="flex justify-between items-center px-4 py-2 bg-dark-800 text-xs text-gray-300">
  <div class="flex items-center space-x-1">
    <div class="w-1 h-1 bg-white rounded-full"></div>
    <div class="w-1 h-1 bg-white rounded-full"></div>
    <div class="w-1 h-1 bg-gray-600 rounded-full"></div>
    <span class="ml-2">Xiaomi Pad</span>
  </div>
  <div class="font-medium">9:41</div>
  <div class="flex items-center space-x-1">
    <i class="fa-solid fa-signal text-xs"></i>
    <i class="fa-solid fa-wifi text-xs"></i>
    <div class="w-6 h-3 border border-white rounded-sm"><div class="w-4 h-2 bg-white rounded-sm m-0.5"></div></div>
  </div>
</div>

<!-- App Header -->
<div id="app-header" class="flex items-center justify-between px-6 py-4 bg-dark-800 border-b border-dark-600">
  <div class="flex items-center space-x-3">
    <button id="back-btn" class="w-8 h-8 bg-dark-600 rounded-full flex items-center justify-center">
      <i class="fa-solid fa-arrow-left text-gray-300 text-sm"></i>
    </button>
    <div>
      <h1 class="text-lg font-semibold text-white">Whisper Processing</h1>
      <p class="text-xs text-gray-400">Step 2: Transcribing Audio</p>
    </div>
  </div>
  <div class="flex items-center space-x-3">
    <div class="flex items-center space-x-2">
      <div class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>
      <span class="text-sm text-purple-400 font-medium">Processing</span>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="px-6 py-6 pb-24">
  
  <!-- Processing Status Card -->
  <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-2xl p-6 mb-6 border border-dark-600">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold text-white">Processing Status</h2>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
        <span class="text-sm text-white font-medium">Step 2/3</span>
      </div>
    </div>
    <div class="grid grid-cols-2 gap-4 text-sm">
      <div>
        <p class="text-gray-300">Batch ID</p>
        <p class="text-white font-medium" id="batch-id">batch_12345</p>
      </div>
      <div>
        <p class="text-gray-300">Files</p>
        <p class="text-white font-medium" id="file-count">3 videos</p>
      </div>
      <div>
        <p class="text-gray-300">Model</p>
        <p class="text-white font-medium" id="model-name">ggml-small.en.bin</p>
      </div>
      <div>
        <p class="text-gray-300">Preset</p>
        <p class="text-white font-medium" id="preset-name">Single</p>
      </div>
    </div>
  </div>

  <!-- Progress Overview -->
  <div class="bg-dark-700 rounded-2xl p-6 border border-dark-600 mb-6">
    <h3 class="text-lg font-semibold text-white mb-4">Progress Overview</h3>
    
    <!-- Overall Progress -->
    <div class="mb-6">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm text-gray-300">Overall Progress</span>
        <span class="text-sm text-white font-medium" id="overall-progress">0%</span>
      </div>
      <div class="w-full bg-dark-600 rounded-full h-3">
        <div class="bg-gradient-to-r from-purple-500 to-blue-500 h-3 rounded-full progress-bar" id="overall-progress-bar" style="width: 0%"></div>
      </div>
    </div>

    <!-- Current File Processing -->
    <div class="mb-6">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm text-gray-300">Current File</span>
        <span class="text-sm text-white font-medium" id="current-file-progress">0%</span>
      </div>
      <div class="w-full bg-dark-600 rounded-full h-2">
        <div class="bg-gradient-to-r from-green-500 to-teal-500 h-2 rounded-full progress-bar" id="current-file-progress-bar" style="width: 0%"></div>
      </div>
      <p class="text-xs text-gray-400 mt-1" id="current-file-name">Preparing...</p>
    </div>

    <!-- Processing Stats -->
    <div class="grid grid-cols-3 gap-4">
      <div class="text-center">
        <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center mx-auto mb-2">
          <i class="fa-solid fa-clock text-purple-400 text-lg"></i>
        </div>
        <p class="text-2xl font-bold text-white" id="elapsed-time">0:00</p>
        <p class="text-xs text-gray-400">Elapsed</p>
      </div>
      <div class="text-center">
        <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center mx-auto mb-2">
          <i class="fa-solid fa-microchip text-blue-400 text-lg"></i>
        </div>
        <p class="text-2xl font-bold text-white" id="rtf-value">—</p>
        <p class="text-xs text-gray-400">RTF</p>
      </div>
      <div class="text-center">
        <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center mx-auto mb-2">
          <i class="fa-solid fa-check-circle text-green-400 text-lg"></i>
        </div>
        <p class="text-2xl font-bold text-white" id="completed-files">0</p>
        <p class="text-xs text-gray-400">Completed</p>
      </div>
    </div>
  </div>

  <!-- File Processing Queue -->
  <div class="bg-dark-700 rounded-2xl p-6 border border-dark-600 mb-6">
    <h3 class="text-lg font-semibold text-white mb-4">Processing Queue</h3>
    <div id="file-queue" class="space-y-3">
      <!-- Files will be populated dynamically -->
    </div>
  </div>

  <!-- Xiaomi Resource Monitor -->
  <div class="bg-gradient-to-br from-dark-700 to-dark-600 rounded-2xl p-6 border border-dark-600 mb-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-white">Xiaomi Resource Usage</h3>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
        <span class="text-sm text-blue-400 font-medium">Live</span>
      </div>
    </div>
    
    <!-- Resource Stats Grid -->
    <div class="grid grid-cols-2 gap-4 mb-4">
      <div class="bg-dark-600 rounded-xl p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center space-x-2">
            <i class="fa-solid fa-memory text-orange-400"></i>
            <span class="text-sm text-gray-300">Memory</span>
          </div>
          <span class="text-lg font-bold text-white" id="resource-memory">0%</span>
        </div>
        <div class="w-full bg-dark-500 rounded-full h-2">
          <div class="bg-gradient-to-r from-orange-500 to-red-500 h-2 rounded-full transition-all duration-300" id="memory-bar" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="bg-dark-600 rounded-xl p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center space-x-2">
            <i class="fa-solid fa-microchip text-blue-400"></i>
            <span class="text-sm text-gray-300">CPU</span>
          </div>
          <span class="text-lg font-bold text-white" id="resource-cpu">0%</span>
        </div>
        <div class="w-full bg-dark-500 rounded-full h-2">
          <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-300" id="cpu-bar" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="bg-dark-600 rounded-xl p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center space-x-2">
            <i class="fa-solid fa-battery-half text-green-400"></i>
            <span class="text-sm text-gray-300">Battery</span>
          </div>
          <span class="text-lg font-bold text-white" id="resource-battery">0%</span>
        </div>
        <div class="w-full bg-dark-500 rounded-full h-2">
          <div class="bg-gradient-to-r from-green-500 to-yellow-500 h-2 rounded-full transition-all duration-300" id="battery-bar" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="bg-dark-600 rounded-xl p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center space-x-2">
            <i class="fa-solid fa-thermometer-half text-red-400"></i>
            <span class="text-sm text-gray-300">Temperature</span>
          </div>
          <span class="text-lg font-bold text-white" id="resource-temperature">0°C</span>
        </div>
        <div class="text-xs text-gray-400 mt-1" id="temperature-status">Normal</div>
      </div>
    </div>
    
    <!-- Processing Details -->
    <div class="bg-dark-600 rounded-xl p-4">
      <h4 class="text-sm font-semibold text-gray-300 mb-3">Processing Details</h4>
      <div class="space-y-2 text-xs">
        <div class="flex justify-between">
          <span class="text-gray-400">Threads:</span>
          <span class="text-white" id="thread-count">4</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-400">Processing Speed:</span>
          <span class="text-white" id="processing-speed">Normal</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-400">Estimated Time:</span>
          <span class="text-white" id="estimated-time">Calculating...</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-400">Last Update:</span>
          <span class="text-white" id="last-update">Never</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Processing Log -->
  <div class="bg-dark-700 rounded-2xl p-6 border border-dark-600 mb-6">
    <h3 class="text-lg font-semibold text-white mb-4">Processing Log</h3>
    <div id="processing-log" class="space-y-2 max-h-48 overflow-y-auto text-xs">
      <div class="text-gray-400">Starting whisper processing...</div>
    </div>
  </div>
</div>

<!-- Bottom Navigation -->
<div id="bottom-navigation" class="fixed bottom-0 left-0 right-0 bg-dark-800 border-t border-dark-600 px-6 py-3 pb-[env(safe-area-inset-bottom)]">
  <div class="flex items-center justify-between">
    <div class="flex items-center space-x-6">
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
        <span class="text-xs text-green-400 font-medium">Select</span>
      </div>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>
        <span class="text-xs text-purple-400 font-medium">Processing</span>
      </div>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-gray-600 rounded-full"></div>
        <span class="text-xs text-gray-500">Results</span>
      </div>
    </div>
    <div class="text-xs text-gray-500">Whisper Processing</div>
  </div>
</div>

<script>
/* ===================== WHISPER: PROCESSING PAGE ===================== */

(() => {
  // State management
  const state = {
    batchId: 'batch_12345',
    totalFiles: 3,
    completedFiles: 0,
    currentFileIndex: 0,
    currentFileProgress: 0,
    overallProgress: 0,
    startTime: Date.now(),
    isProcessing: true,
    files: [
      { name: 'video1.mp4', status: 'processing', progress: 0 },
      { name: 'video2.avi', status: 'pending', progress: 0 },
      { name: 'video3.mov', status: 'pending', progress: 0 }
    ]
  };

  // DOM Elements
  const backBtn = document.getElementById('back-btn');
  const batchIdElement = document.getElementById('batch-id');
  const fileCountElement = document.getElementById('file-count');
  const modelNameElement = document.getElementById('model-name');
  const presetNameElement = document.getElementById('preset-name');
  const overallProgressElement = document.getElementById('overall-progress');
  const overallProgressBar = document.getElementById('overall-progress-bar');
  const currentFileProgressElement = document.getElementById('current-file-progress');
  const currentFileProgressBar = document.getElementById('current-file-progress-bar');
  const currentFileNameElement = document.getElementById('current-file-name');
  const elapsedTimeElement = document.getElementById('elapsed-time');
  const rtfValueElement = document.getElementById('rtf-value');
  const completedFilesElement = document.getElementById('completed-files');
  const fileQueueElement = document.getElementById('file-queue');
  const processingLogElement = document.getElementById('processing-log');

  // Bridge contract (provided by Android WebView)
  const hasBridge = typeof window.WhisperBridge !== 'undefined';
  const bridge = hasBridge ? {
    async getResourceStats() { 
      if (window.WhisperBridge.getResourceStats) {
        return window.WhisperBridge.getResourceStats();
      }
    },
    async goBack() {
      if (window.WhisperBridge.goBack) {
        return window.WhisperBridge.goBack();
      }
    },
    async getLatestSidecar() {
      if (window.WhisperBridge.getLatestSidecar) {
        return window.WhisperBridge.getLatestSidecar();
      }
    }
  } : mockBridge();

  function mockBridge() {
    return {
      async getResourceStats() { 
        return JSON.stringify({
          memory: Math.floor(Math.random() * 50) + 20,
          cpu: Math.floor(Math.random() * 30) + 10,
          battery: Math.floor(Math.random() * 40) + 60,
          temperature: Math.floor(Math.random() * 10) + 35,
          batteryDetails: 'Level: 75%, Temp: 37.2°C, Voltage: 4.1V',
          gpuInfo: 'GPU: Adreno 640',
          threadInfo: 'Threads: 45 | Main: main | Active: 12 | CPUs: 8 | Est. Processing: 16',
          timestamp: Date.now()
        });
      },
      async goBack() { 
        console.log('Mock: Going back');
        return 'ok';
      },
      async getLatestSidecar() {
        return JSON.stringify({
          job_id: state.batchId,
          uri: 'file:///sdcard/video1.mp4',
          preset: 'Single',
          rtf: 0.45,
          created_at: Date.now()
        });
      }
    };
  }

  // Utility Functions
  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  function addLogMessage(message, type = 'info') {
    const logEntry = document.createElement('div');
    const timestamp = new Date().toLocaleTimeString();
    const colors = {
      info: 'text-gray-300',
      success: 'text-green-400',
      warning: 'text-yellow-400',
      error: 'text-red-400'
    };
    
    logEntry.className = `${colors[type]} processing-animation`;
    logEntry.textContent = `[${timestamp}] ${message}`;
    
    processingLogElement.appendChild(logEntry);
    processingLogElement.scrollTop = processingLogElement.scrollHeight;
    
    // Keep only last 50 log entries
    while (processingLogElement.children.length > 50) {
      processingLogElement.removeChild(processingLogElement.firstChild);
    }
  }

  function updateProgress() {
    // Update overall progress
    overallProgressElement.textContent = `${state.overallProgress}%`;
    overallProgressBar.style.width = `${state.overallProgress}%`;
    
    // Update current file progress
    currentFileProgressElement.textContent = `${state.currentFileProgress}%`;
    currentFileProgressBar.style.width = `${state.currentFileProgress}%`;
    
    // Update current file name
    if (state.currentFileIndex < state.files.length) {
      currentFileNameElement.textContent = state.files[state.currentFileIndex].name;
    }
    
    // Update completed files
    completedFilesElement.textContent = state.completedFiles;
    
    // Update elapsed time
    const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
    elapsedTimeElement.textContent = formatTime(elapsed);
  }

  function renderFileQueue() {
    fileQueueElement.innerHTML = '';
    
    state.files.forEach((file, index) => {
      const fileDiv = document.createElement('div');
      fileDiv.className = 'flex items-center justify-between bg-dark-600 rounded-lg p-3';
      
      const statusColors = {
        pending: 'text-gray-400',
        processing: 'text-blue-400',
        completed: 'text-green-400',
        error: 'text-red-400'
      };
      
      const statusIcons = {
        pending: 'fa-clock',
        processing: 'fa-spinner fa-spin',
        completed: 'fa-check-circle',
        error: 'fa-exclamation-circle'
      };
      
      fileDiv.innerHTML = `
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-dark-700 rounded-lg flex items-center justify-center">
            <i class="fa-solid ${statusIcons[file.status]} ${statusColors[file.status]} text-sm"></i>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm text-white font-medium truncate">${file.name}</p>
            <p class="text-xs ${statusColors[file.status]}">${file.status.charAt(0).toUpperCase() + file.status.slice(1)}</p>
          </div>
        </div>
        <div class="text-right">
          <p class="text-sm text-white font-medium">${file.progress}%</p>
          <div class="w-16 bg-dark-500 rounded-full h-1 mt-1">
            <div class="bg-gradient-to-r from-purple-500 to-blue-500 h-1 rounded-full" style="width: ${file.progress}%"></div>
          </div>
        </div>
      `;
      
      fileQueueElement.appendChild(fileDiv);
    });
  }

  function simulateProcessing() {
    if (!state.isProcessing) return;
    
    // Simulate current file progress
    if (state.currentFileIndex < state.files.length) {
      const currentFile = state.files[state.currentFileIndex];
      if (currentFile.status === 'processing') {
        currentFile.progress += Math.random() * 5;
        if (currentFile.progress >= 100) {
          currentFile.progress = 100;
          currentFile.status = 'completed';
          state.completedFiles++;
          state.currentFileIndex++;
          
          addLogMessage(`Completed: ${currentFile.name}`, 'success');
          
          // Start next file
          if (state.currentFileIndex < state.files.length) {
            state.files[state.currentFileIndex].status = 'processing';
            addLogMessage(`Starting: ${state.files[state.currentFileIndex].name}`, 'info');
          } else {
            // All files completed
            state.isProcessing = false;
            addLogMessage('All files processed successfully!', 'success');
            setTimeout(() => {
              // Navigate to results page
              if (hasBridge && window.WhisperBridge.openWhisperResults) {
                window.WhisperBridge.openWhisperResults();
              } else {
                addLogMessage('Processing complete - navigate to Results', 'success');
              }
            }, 2000);
          }
        }
      }
    }
    
    // Update overall progress
    state.overallProgress = Math.floor((state.completedFiles / state.totalFiles) * 100);
    
    // Update current file progress
    if (state.currentFileIndex < state.files.length) {
      state.currentFileProgress = state.files[state.currentFileIndex].progress;
    }
    
    updateProgress();
    renderFileQueue();
  }

  // Global resource monitoring integration
  function updateResourceStats(statsJson) {
    try {
      const stats = JSON.parse(statsJson);
      
      // Update local resource displays
      document.getElementById('resource-memory').textContent = stats.memory + '%';
      document.getElementById('resource-cpu').textContent = stats.cpu.toFixed(1) + '%';
      document.getElementById('resource-battery').textContent = stats.battery + '%';
      document.getElementById('resource-temperature').textContent = stats.temperature.toFixed(1) + '°C';
      
      // Update progress bars
      document.getElementById('memory-bar').style.width = stats.memory + '%';
      document.getElementById('cpu-bar').style.width = stats.cpu + '%';
      document.getElementById('battery-bar').style.width = stats.battery + '%';
      
      // Update detailed information
      document.getElementById('battery-details').textContent = stats.batteryDetails || 'N/A';
      document.getElementById('gpu-info').textContent = stats.gpuInfo || 'N/A';
      document.getElementById('thread-info').textContent = stats.threadInfo || 'N/A';
      
      // Update timestamp
      const updateTime = new Date(stats.timestamp).toLocaleTimeString();
      document.getElementById('last-update').textContent = updateTime;
      
      // Update temperature status
      const tempStatus = document.getElementById('temperature-status');
      if (stats.temperature > 40) {
        tempStatus.textContent = 'Hot';
        tempStatus.className = 'text-xs text-red-400 mt-1';
      } else if (stats.temperature < 30) {
        tempStatus.textContent = 'Cool';
        tempStatus.className = 'text-xs text-blue-400 mt-1';
      } else {
        tempStatus.textContent = 'Normal';
        tempStatus.className = 'text-xs text-green-400 mt-1';
      }
      
      // Update RTF if available
      if (stats.rtf) {
        rtfValueElement.textContent = stats.rtf.toFixed(2);
      }
      
      // Update global resource monitor if available
      if (window.updateGlobalResourceStats) {
        window.updateGlobalResourceStats(statsJson);
      }
      
      console.log('Resource stats updated from connector service:', stats);
      
    } catch (e) {
      console.error('Error parsing resource stats:', e);
    }
  }
  
  // Connector service event handlers
  function handleProcessingStart(batchId, fileCount) {
    console.log('Processing started:', batchId, 'with', fileCount, 'files');
    
    // Update UI with real batch data
    state.batchId = batchId;
    state.totalFiles = fileCount;
    state.completedFiles = 0;
    state.currentFileIndex = 0;
    state.isProcessing = true;
    
    // Update display
    batchIdElement.textContent = batchId;
    fileCountElement.textContent = `${fileCount} videos`;
    
    // Initialize file queue
    state.files = [];
    for (let i = 0; i < fileCount; i++) {
      state.files.push({
        name: `video_${i + 1}.mp4`,
        status: i === 0 ? 'processing' : 'pending',
        progress: 0
      });
    }
    
    renderFileQueue();
    addLogMessage(`Processing started: ${batchId}`, 'info');
  }
  
  function handleProgressUpdate(batchId, progress, fileCount, currentFile) {
    console.log('Progress update:', batchId, progress + '%', `file ${currentFile}/${fileCount}`);
    
    // Update state
    state.overallProgress = progress;
    state.currentFileIndex = currentFile;
    
    // Update current file progress
    if (currentFile < state.files.length) {
      state.files[currentFile].progress = progress;
      state.currentFileProgress = progress;
    }
    
    // Update completed files
    state.completedFiles = Math.floor((progress / 100) * fileCount);
    
    updateProgress();
    renderFileQueue();
    
    addLogMessage(`Progress: ${progress}% (file ${currentFile + 1}/${fileCount})`, 'info');
  }
  
  function handleProcessingComplete(batchId) {
    console.log('Processing complete:', batchId);
    
    state.isProcessing = false;
    state.overallProgress = 100;
    state.currentFileProgress = 100;
    
    // Mark all files as completed
    state.files.forEach(file => {
      file.status = 'completed';
      file.progress = 100;
    });
    
    updateProgress();
    renderFileQueue();
    
    addLogMessage('All files processed successfully!', 'success');
    
    // Navigate to results after delay
    setTimeout(() => {
      if (hasBridge && window.WhisperBridge.openWhisperResults) {
        window.WhisperBridge.openWhisperResults();
      } else {
        addLogMessage('Processing complete - navigate to Results', 'success');
      }
    }, 2000);
  }
  
  // Make functions globally available for connector service
  window.updateResourceStats = updateResourceStats;
  window.handleProcessingStart = handleProcessingStart;
  window.handleProgressUpdate = handleProgressUpdate;
  window.handleProcessingComplete = handleProcessingComplete;

  // Event Handlers
  backBtn.onclick = async () => {
    try {
      await bridge.goBack();
    } catch (e) {
      console.error('Error going back:', e);
    }
  };

  // Initialize
  batchIdElement.textContent = state.batchId;
  fileCountElement.textContent = `${state.totalFiles} videos`;
  modelNameElement.textContent = 'ggml-small.en.bin';
  presetNameElement.textContent = 'Single';
  
  updateProgress();
  renderFileQueue();
  
  addLogMessage('Whisper processing initialized', 'info');
  addLogMessage(`Starting batch: ${state.batchId}`, 'info');
  addLogMessage(`Processing ${state.totalFiles} files`, 'info');
  
  // Start processing simulation
  const processingInterval = setInterval(() => {
    simulateProcessing();
    if (!state.isProcessing) {
      clearInterval(processingInterval);
    }
  }, 500);
  
  // Initialize resource monitoring
  async function initializeResourceMonitoring() {
    try {
      const stats = await bridge.getResourceStats();
      updateResourceStats(stats);
    } catch (e) {
      console.error('Error initializing resource monitoring:', e);
    }
  }

  // Start resource monitoring
  initializeResourceMonitoring();
  if (hasBridge) {
    setInterval(async () => {
      try {
        const stats = await bridge.getResourceStats();
        updateResourceStats(stats);
      } catch (e) {
        console.error('Resource monitoring error:', e);
      }
    }, 2000);
  }

  // Initialize global resource monitor
  async function initializeGlobalResourceMonitor() {
    try {
      // Load the global resource monitor component
      const monitorResponse = await fetch('global_resource_monitor.html');
      if (monitorResponse.ok) {
        const monitorHtml = await monitorResponse.text();
        const monitorContainer = document.createElement('div');
        monitorContainer.innerHTML = monitorHtml;
        document.body.appendChild(monitorContainer);
        
        // Initialize the global monitor
        if (window.initializeGlobalResourceMonitor) {
          window.initializeGlobalResourceMonitor();
        }
        console.log('Global resource monitor initialized');
      }
    } catch (e) {
      console.error('Error initializing global resource monitor:', e);
    }
  }

  // Initialize global resource monitor
  initializeGlobalResourceMonitor();

  console.log('Whisper Processing initialized');

})();
</script>

</body>
</html>