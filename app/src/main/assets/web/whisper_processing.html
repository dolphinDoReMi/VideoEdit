<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>*{font-family:'Inter',sans-serif}::-webkit-scrollbar{display:none}</style>
</head>
<body class="bg-[#0a0a0a] text-white">

<div class="px-6 py-4 bg-[#1a1a1a] border-b border-[#3a3a3a] flex items-center justify-between">
  <div>
    <h1 class="text-lg font-semibold">Whisper — Processing</h1>
    <p class="text-xs text-gray-400">Transcribing videos...</p>
  </div>
</div>

<div id="processing-status" class="px-6 py-4">
  <div class="bg-[#1a1a1a] rounded-xl p-4 border border-[#3a3a3a]">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-white font-semibold">Processing Status</h2>
      <div class="flex items-center space-x-2"><div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div><span class="text-green-400 text-sm font-medium">Running</span></div>
    </div>
    <div class="w-full bg-[#3a3a3a] rounded-full h-2 mb-3"><div id="progress-bar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all duration-500" style="width:0%"></div></div>
    <div class="flex items-center justify-between text-sm"><span id="step-title" class="text-gray-300">Initializing...</span><span id="step-progress" class="text-white font-medium">0%</span></div>
  </div>
</div>

<div id="whisper-batch" class="px-6 py-2">
  <div class="bg-[#1a1a1a] rounded-xl p-4 border border-[#3a3a3a]">
    <h3 class="text-white font-semibold mb-2">Whisper Batch</h3>
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div><div class="text-gray-400">Total</div><div id="wb-total" class="text-white font-semibold">0</div></div>
      <div><div class="text-gray-400">Done</div><div id="wb-done" class="text-white font-semibold">0</div></div>
      <div><div class="text-gray-400">Remaining</div><div id="wb-remaining" class="text-white font-semibold">0</div></div>
      <div><div class="text-gray-400">RTF</div><div id="wb-rtf" class="text-white font-semibold">—</div></div>
    </div>
    <div class="mt-2 text-xs text-gray-400 truncate">Current: <span id="wb-current">—</span></div>
  </div>
  </div>

<div id="system-resources" class="px-6 py-2">
  <div class="bg-[#1a1a1a] rounded-xl p-4 border border-[#3a3a3a]">
    <h3 class="text-white font-semibold mb-2">Xiaomi Resource Usage</h3>
    <div class="grid grid-cols-2 gap-4">
      <div class="text-center"><div class="text-gray-400 text-xs mb-1">CPU</div><div id="cpu-value" class="text-white font-bold text-lg">0%</div></div>
      <div class="text-center"><div class="text-gray-400 text-xs mb-1">Memory</div><div id="memory-value" class="text-white font-bold text-lg">0%</div></div>
      <div class="text-center"><div class="text-gray-400 text-xs mb-1">Battery</div><div id="battery-value" class="text-white font-bold text-lg">0%</div></div>
      <div class="text-center"><div class="text-gray-400 text-xs mb-1">Temp</div><div id="temperature" class="text-white font-bold text-lg">0°C</div></div>
    </div>
  </div>
</div>

<div id="processing-log" class="px-6 py-2">
  <div class="bg-[#1a1a1a] rounded-xl p-4 border border-[#3a3a3a]">
    <h3 class="text-white font-semibold mb-2">Log</h3>
    <div id="log" class="space-y-2 max-h-40 overflow-y-auto text-sm"></div>
  </div>
</div>

<div id="whisper-transcript" class="px-6 py-2" style="display:none;">
  <div class="bg-[#1a1a1a] rounded-xl p-4 border border-[#3a3a3a]">
    <h3 class="text-white font-semibold mb-2">Transcription</h3>
    <pre id="tx" class="text-sm text-gray-200 whitespace-pre-wrap max-h-80 overflow-y-auto">Loading...</pre>
  </div>
</div>

<script>
function addLogEntry(t){ const log=document.getElementById('log'); const d=document.createElement('div'); d.textContent=t; log.appendChild(d); log.scrollTop=log.scrollHeight; }
// Live resource updates (called from Android)
function updateRealResourceUsage(cpu, memPct, battery, temp){
  document.getElementById('cpu-value').textContent = Math.round(cpu)+'%';
  document.getElementById('memory-value').textContent = Math.round(memPct)+'%';
  document.getElementById('battery-value').textContent = battery+'%';
  document.getElementById('temperature').textContent = Math.round(temp)+'°C';
}
// Batch channel
(function(){
  if ('BroadcastChannel' in window){
    const ch = new BroadcastChannel('whisper-ui');
    ch.onmessage = (e)=>{
      const d=e.data||{};
      if(d.type==='whisper.run' && Array.isArray(d.uris)){
        document.getElementById('wb-total').textContent=d.uris.length;
        document.getElementById('wb-remaining').textContent=d.uris.length;
        document.getElementById('wb-current').textContent=d.uris[0]||'—';
        addLogEntry('Batch started');
      }else if(d.type==='whisper.progress'){
        if(typeof d.pct==='number'){
          document.getElementById('step-progress').textContent=d.pct+'%';
          document.getElementById('progress-bar').style.width=d.pct+'%';
        }
        if(d.msg) addLogEntry(d.msg);
      }else if(d.type==='whisper.done'){
        const t=Number(document.getElementById('wb-total').textContent)||0;
        const done=Math.min(t,(Number(document.getElementById('wb-done').textContent)||0)+1);
        document.getElementById('wb-done').textContent=done;
        document.getElementById('wb-remaining').textContent=Math.max(0,t-done);
        if(d.rtf!=null) document.getElementById('wb-rtf').textContent=Number(d.rtf).toFixed(2);
        addLogEntry('Finished '+(d.uri||''));
      }else if(d.type==='whisper.error'){
        addLogEntry('Error: '+(d.error||'unknown'));
      }
    };
  }
})();
// Reveal transcript via bridge
function revealTranscript(){ try{ if(window.WhisperBridge&&window.WhisperBridge.getLatestTranscript){ const txt=window.WhisperBridge.getLatestTranscript(); document.getElementById('whisper-transcript').style.display='block'; document.getElementById('tx').textContent=txt||'No transcript.'; } }catch(e){}
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  function pullStatsOnce(){
    try {
      if (window.WhisperBridge && window.WhisperBridge.getResourceStats) {
        const s = window.WhisperBridge.getResourceStats();
        const data = typeof s === 'string' ? JSON.parse(s) : s;
        if (data) {
          updateRealResourceUsage(
            Number(data.cpu || 0),
            Number(data.memory || 0),
            Number(data.battery || 0),
            Number(data.temperature || 0),
            data.batteryDetails || '',
            data.gpuInfo || '',
            data.threadInfo || ''
          );
        }
      }
    } catch (e) {}
  }

  // Kick off immediate and periodic resource updates
  pullStatsOnce();
  window.__whisperStatsTimer = setInterval(pullStatsOnce, 2000);

  // Poll transcript; when available, reveal and mark as completed
  function tryReveal(){
    try {
      if (window.WhisperBridge && window.WhisperBridge.getLatestTranscript) {
        const txt = window.WhisperBridge.getLatestTranscript();
        if (txt && txt.length > 0) {
          const tx = document.getElementById('tx');
          const panel = document.getElementById('whisper-transcript');
          if (panel) panel.style.display = 'block';
          if (tx) tx.textContent = txt;
          // Update status to completed
          const headerStatus = document.querySelector('#processing-status .text-green-400');
          if (headerStatus) headerStatus.textContent = 'Completed';
          const dots = document.querySelectorAll('.w-2.h-2');
          dots.forEach(el => {
            if (el.className.indexOf('bg-green-500') !== -1 || el.className.indexOf('bg-blue-500') !== -1) {
              el.className = 'w-2 h-2 bg-green-500 rounded-full';
            }
          });
          clearInterval(window.__whisperTranscriptTimer);
        }
      }
    } catch(e) {}
  }
  window.__whisperTranscriptTimer = setInterval(tryReveal, 3000);

  // Liveness: gently advance progress if no events are received
  let fallbackProgress = 0;
  window.__whisperProgressTimer = setInterval(() => {
    const stepEl = document.getElementById('step-progress');
    const bar = document.getElementById('progress-bar');
    if (!stepEl || !bar) return;
    const current = parseInt(String(stepEl.textContent).replace('%','')) || 0;
    if (current === 0 || current === fallbackProgress) {
      fallbackProgress = Math.min(95, current + 1);
      stepEl.textContent = fallbackProgress + '%';
      bar.style.width = fallbackProgress + '%';
    } else {
      fallbackProgress = current;
    }
  }, 1500);
});
</script>

</body>
</html>

