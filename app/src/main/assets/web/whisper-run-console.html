<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script> window.FontAwesomeConfig = { autoReplaceSvg: 'nest'};</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>::-webkit-scrollbar { display: none;} * { font-family: 'Inter', sans-serif; }</style>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { dark: { 900:'#0a0a0a',800:'#1a1a1a',700:'#2a2a2a',600:'#3a3a3a' }}}}
    }
  </script>
</head>
<body class="bg-dark-900 text-white overflow-x-hidden">

<!-- Status Bar -->
<div id="status-bar" class="flex justify-between items-center px-4 py-2 bg-dark-800 text-xs text-gray-300">
  <div class="flex items-center space-x-1">
    <div class="w-1 h-1 bg-white rounded-full"></div>
    <div class="w-1 h-1 bg-white rounded-full"></div>
    <div class="w-1 h-1 bg-gray-600 rounded-full"></div>
    <span class="ml-2">Verizon</span>
  </div>
  <div class="font-medium">9:41</div>
  <div class="flex items-center space-x-1">
    <i class="fa-solid fa-signal text-xs"></i>
    <i class="fa-solid fa-wifi text-xs"></i>
    <div class="w-6 h-3 border border-white rounded-sm"><div class="w-4 h-2 bg-white rounded-sm m-0.5"></div></div>
  </div>
</div>

<!-- App Header -->
<div id="app-header" class="flex items-center justify-between px-6 py-4 bg-dark-800 border-b border-dark-600">
  <div class="flex items-center space-x-3">
    <button class="w-8 h-8 bg-dark-600 rounded-full flex items-center justify-center" onclick="goBack()">
      <i class="fa-solid fa-arrow-left text-gray-300 text-sm"></i>
    </button>
    <div>
      <h1 class="text-lg font-semibold text-white">Run Console</h1>
      <p class="text-xs text-gray-400">Observe Whisper Jobs from Sidecars</p>
    </div>
  </div>
  <div class="flex items-center space-x-3">
    <button id="refresh-btn" class="px-3 py-2 bg-dark-600 rounded-lg text-sm" onclick="refreshJobs()">
      <i class="fa-solid fa-rotate mr-2"></i>Refresh
    </button>
    <button class="w-8 h-8 bg-dark-600 rounded-full flex items-center justify-center">
      <i class="fa-solid fa-ellipsis-vertical text-gray-300 text-sm"></i>
    </button>
  </div>
</div>

<!-- Run Console Table -->
<div id="run-console" class="px-6 py-4">
  <div class="bg-dark-700 rounded-xl border border-dark-600">
    <!-- Header Row -->
    <div class="grid grid-cols-4 gap-2 px-4 py-3 text-xs text-gray-400 border-b border-dark-600 font-medium">
      <div>Job ID</div>
      <div>File</div>
      <div>RTF</div>
      <div>Status</div>
    </div>
    
    <!-- Jobs List -->
    <div id="jobs-list" class="min-h-96">
      <!-- Jobs will be populated here -->
    </div>
    
    <!-- Empty State -->
    <div id="empty-state" class="hidden px-4 py-8 text-center text-gray-400">
      <i class="fa-solid fa-folder-open text-4xl mb-4"></i>
      <p class="text-lg font-medium mb-2">No Jobs Found</p>
      <p class="text-sm">Jobs will appear here when Whisper processing starts</p>
      <p class="text-xs mt-2">Looking in: /sdcard/MiraWhisper/out/</p>
    </div>
  </div>
</div>

<!-- Job Details Modal -->
<div id="job-details-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-dark-700 rounded-xl p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-white">Job Details</h3>
      <button onclick="closeJobDetails()" class="w-8 h-8 bg-dark-600 rounded-full flex items-center justify-center">
        <i class="fa-solid fa-times text-gray-300 text-sm"></i>
      </button>
    </div>
    <div id="job-details-content" class="space-y-3 text-sm">
      <!-- Job details will be populated here -->
    </div>
  </div>
</div>

<script>
/* ============================
   Run Console Implementation
   ============================ */

// State
let jobs = [];
let isRefreshing = false;

// Job status colors
const statusColors = {
  'RUNNING': 'bg-blue-600',
  'COMPLETED': 'bg-green-600', 
  'ERROR': 'bg-red-600',
  'TIMEOUT': 'bg-yellow-600'
};

/* Initialize */
async function init() {
  await refreshJobs();
  // Auto-refresh every 5 seconds
  setInterval(refreshJobs, 5000);
}

/* Refresh jobs from Android bridge */
async function refreshJobs() {
  if (isRefreshing) return;
  isRefreshing = true;
  
  try {
    // Call Android bridge to get jobs
    if (window.AndroidWhisper) {
      const jobsJson = window.AndroidWhisper.listSidecars();
      jobs = JSON.parse(jobsJson);
    } else {
      // Mock data for testing
      jobs = getMockJobs();
    }
    
    renderJobs();
  } catch (error) {
    console.error('Failed to refresh jobs:', error);
    showError('Failed to load jobs');
  } finally {
    isRefreshing = false;
  }
}

/* Render jobs table */
function renderJobs() {
  const jobsList = document.getElementById('jobs-list');
  const emptyState = document.getElementById('empty-state');
  
  if (jobs.length === 0) {
    jobsList.innerHTML = '';
    emptyState.classList.remove('hidden');
    return;
  }
  
  emptyState.classList.add('hidden');
  
  jobsList.innerHTML = jobs.map(job => `
    <div class="border-b border-dark-600">
      <div class="grid grid-cols-4 gap-2 px-4 py-3 items-center cursor-pointer hover:bg-dark-600" onclick="showJobDetails('${job.jobId}')">
        <div class="text-sm text-white truncate">${job.jobId}</div>
        <div class="text-sm text-gray-300 truncate">${job.baseName || '—'}</div>
        <div class="text-sm text-gray-300">${job.rtf ? job.rtf.toFixed(2) : '—'}</div>
        <div>${renderStatusPill(job.status)}</div>
      </div>
    </div>
  `).join('');
}

/* Render status pill */
function renderStatusPill(status) {
  const color = statusColors[status] || 'bg-gray-600';
  return `<span class="text-xs px-2 py-1 rounded text-white ${color}">${status}</span>`;
}

/* Show job details modal */
function showJobDetails(jobId) {
  const job = jobs.find(j => j.jobId === jobId);
  if (!job) return;
  
  const modal = document.getElementById('job-details-modal');
  const content = document.getElementById('job-details-content');
  
  content.innerHTML = `
    <div class="grid grid-cols-2 gap-4">
      <div>
        <p class="text-gray-400 text-xs">Job ID</p>
        <p class="text-white font-mono text-sm">${job.jobId}</p>
      </div>
      <div>
        <p class="text-gray-400 text-xs">Status</p>
        <p class="text-white">${renderStatusPill(job.status)}</p>
      </div>
      <div>
        <p class="text-gray-400 text-xs">File Name</p>
        <p class="text-white text-sm">${job.baseName || '—'}</p>
      </div>
      <div>
        <p class="text-gray-400 text-xs">RTF</p>
        <p class="text-white text-sm">${job.rtf ? job.rtf.toFixed(3) : '—'}</p>
      </div>
      <div>
        <p class="text-gray-400 text-xs">Audio SHA-256</p>
        <p class="text-white font-mono text-xs break-all">${job.audioSha256 || '—'}</p>
      </div>
      <div>
        <p class="text-gray-400 text-xs">Model SHA-256</p>
        <p class="text-white font-mono text-xs break-all">${job.modelSha256 || '—'}</p>
      </div>
      <div>
        <p class="text-gray-400 text-xs">Transcript SHA-256</p>
        <p class="text-white font-mono text-xs break-all">${job.transcriptSha256 || '—'}</p>
      </div>
      <div>
        <p class="text-gray-400 text-xs">Duration (ms)</p>
        <p class="text-white text-sm">${job.durationMs || '—'}</p>
      </div>
      <div>
        <p class="text-gray-400 text-xs">Started At</p>
        <p class="text-white text-sm">${job.startedAt ? new Date(job.startedAt).toLocaleString() : '—'}</p>
      </div>
      <div>
        <p class="text-gray-400 text-xs">Finished At</p>
        <p class="text-white text-sm">${job.finishedAt ? new Date(job.finishedAt).toLocaleString() : '—'}</p>
      </div>
    </div>
    <div class="mt-4">
      <p class="text-gray-400 text-xs mb-2">Directory Path</p>
      <p class="text-white font-mono text-xs break-all bg-dark-800 p-2 rounded">${job.dirPath || '—'}</p>
    </div>
    ${job.config ? `
    <div class="mt-4">
      <p class="text-gray-400 text-xs mb-2">Configuration</p>
      <pre class="text-white font-mono text-xs bg-dark-800 p-2 rounded overflow-x-auto">${JSON.stringify(job.config, null, 2)}</pre>
    </div>
    ` : ''}
  `;
  
  modal.classList.remove('hidden');
}

/* Close job details modal */
function closeJobDetails() {
  document.getElementById('job-details-modal').classList.add('hidden');
}

/* Go back to main app */
function goBack() {
  if (window.AndroidInterface) {
    window.AndroidInterface.goBack();
  } else {
    history.back();
  }
}

/* Show error message */
function showError(message) {
  // Simple error display - could be enhanced with toast notifications
  console.error(message);
}

/* Mock data for testing */
function getMockJobs() {
  return [
    {
      jobId: "20250104-001",
      baseName: "kickoff.mp4",
      rtf: 0.57,
      status: "COMPLETED",
      audioSha256: "a9f1234567890abcdef1234567890abcdef1234567890abcdef1234567890ab",
      modelSha256: "bb1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcd",
      transcriptSha256: "c331234567890abcdef1234567890abcdef1234567890abcdef1234567890abc",
      durationMs: 154000,
      startedAt: 1704360000000,
      finishedAt: 1704360155000,
      config: { segmentMs: 30000, overlapMs: 1000, preset: "SINGLE" },
      dirPath: "/sdcard/MiraWhisper/out/20250104-001"
    },
    {
      jobId: "20250104-002", 
      baseName: "meeting.mov",
      rtf: null,
      status: "RUNNING",
      audioSha256: "",
      modelSha256: "bb1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcd",
      transcriptSha256: "",
      durationMs: null,
      startedAt: 1704360200000,
      finishedAt: null,
      config: {},
      dirPath: "/sdcard/MiraWhisper/out/20250104-002"
    },
    {
      jobId: "20250104-003",
      baseName: "problem.webm", 
      rtf: null,
      status: "ERROR",
      audioSha256: "",
      modelSha256: "",
      transcriptSha256: "",
      durationMs: null,
      startedAt: null,
      finishedAt: null,
      config: { error: "decode_failed" },
      dirPath: "/sdcard/MiraWhisper/out/20250104-003"
    }
  ];
}

/* Initialize on load */
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
