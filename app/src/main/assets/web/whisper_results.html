<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script> window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    ::-webkit-scrollbar { display: none; }
    * { font-family: 'Inter', sans-serif; }
    @media (prefers-reduced-motion: reduce) { .animate-pulse { animation: none !important; } }
  </style>
  <script>
    tailwind.config = {
      theme: { 
        extend: { 
          colors: { 
            dark: { 900:'#0a0a0a', 800:'#1a1a1a', 700:'#2a2a2a', 600:'#3a3a3a' }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-dark-900 text-white overflow-x-hidden">

<!-- Status Bar -->
<div id="status-bar" class="flex justify-between items-center px-4 py-2 bg-dark-800 text-xs text-gray-300">
  <div class="flex items-center space-x-1">
    <div class="w-1 h-1 bg-white rounded-full"></div>
    <div class="w-1 h-1 bg-white rounded-full"></div>
    <div class="w-1 h-1 bg-gray-600 rounded-full"></div>
    <span class="ml-2">Xiaomi Pad</span>
  </div>
  <div class="font-medium">9:41</div>
  <div class="flex items-center space-x-1">
    <i class="fa-solid fa-signal text-xs"></i>
    <i class="fa-solid fa-wifi text-xs"></i>
    <div class="w-6 h-3 border border-white rounded-sm"><div class="w-4 h-2 bg-white rounded-sm m-0.5"></div></div>
  </div>
</div>

<!-- App Header -->
<div id="app-header" class="flex items-center justify-between px-6 py-4 bg-dark-800 border-b border-dark-600">
  <div class="flex items-center space-x-3">
    <button id="back-btn" class="w-8 h-8 bg-dark-600 rounded-full flex items-center justify-center">
      <i class="fa-solid fa-arrow-left text-gray-300 text-sm"></i>
    </button>
    <div>
      <h1 class="text-lg font-semibold text-white">Whisper Results</h1>
      <p class="text-xs text-gray-400">Step 3: Transcription Complete</p>
    </div>
  </div>
  <div class="flex items-center space-x-3">
    <div class="flex items-center space-x-2">
      <div class="w-2 h-2 bg-green-500 rounded-full"></div>
      <span class="text-sm text-green-400 font-medium">Complete</span>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="px-6 py-6 pb-24">
  
  <!-- Completion Status Card -->
  <div class="bg-gradient-to-r from-green-600 to-blue-600 rounded-2xl p-6 mb-6 border border-dark-600">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold text-white">Processing Complete</h2>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-white rounded-full"></div>
        <span class="text-sm text-white font-medium">Step 3/3</span>
      </div>
    </div>
    <div class="grid grid-cols-2 gap-4 text-sm">
      <div>
        <p class="text-gray-300">Batch ID</p>
        <p class="text-white font-medium" id="batch-id">batch_12345</p>
      </div>
      <div>
        <p class="text-gray-300">Duration</p>
        <p class="text-white font-medium" id="total-duration">2:34</p>
      </div>
      <div>
        <p class="text-gray-300">Processing Time</p>
        <p class="text-white font-medium" id="processing-time">7.2s</p>
      </div>
      <div class="relative group">
        <p class="text-gray-300">RTF</p>
        <p class="text-white font-medium cursor-pointer select-none" id="rtf-value" title="Tap to see RTF explanation">0.45</p>
        
        <!-- RTF Tooltip -->
        <div id="rtf-tooltip" class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-96 bg-dark-800 border border-dark-600 rounded-lg p-4 shadow-xl opacity-0 invisible transition-all duration-200 z-50">
          <div class="text-sm text-white space-y-3">
            <div>
              <h4 class="font-semibold text-blue-400 mb-2">RTF = Real-Time Factor</h4>
              <p class="text-gray-300 mb-2">A speed metric for audio processing</p>
              <div class="bg-dark-700 rounded p-2 font-mono text-xs">
                <strong>RTF</strong> = <span class="text-blue-400">processing time</span> / <span class="text-green-400">audio duration</span>
              </div>
            </div>
            
            <div>
              <h5 class="font-medium text-gray-200 mb-1">Speed Interpretation:</h5>
              <ul class="text-xs text-gray-400 space-y-1">
                <li>• <span class="text-green-400">RTF &lt; 1.0</span> → faster than real-time (e.g., RTF 0.4 = 2.5× real-time)</li>
                <li>• <span class="text-yellow-400">RTF = 1.0</span> → exactly real-time</li>
                <li>• <span class="text-red-400">RTF &gt; 1.0</span> → slower than real-time</li>
              </ul>
            </div>
            
            <div>
              <h5 class="font-medium text-gray-200 mb-1">Why it matters:</h5>
              <ul class="text-xs text-gray-400 space-y-1">
                <li>• <strong>Capacity planning:</strong> estimate device throughput</li>
                <li>• <strong>Regression detection:</strong> track p50/p95 RTF across builds</li>
                <li>• <strong>Thread/model sizing:</strong> see how threads affect speed</li>
                <li>• <strong>On-device viability:</strong> aim for p95 RTF &lt; 1 for smooth UX</li>
              </ul>
            </div>
            
            <div>
              <h5 class="font-medium text-gray-200 mb-1">Target Performance:</h5>
              <ul class="text-xs text-gray-400 space-y-1">
                <li>• <span class="text-green-400">Shipping bar:</span> p95 RTF_e2e &lt; 1.0</li>
                <li>• <span class="text-blue-400">Comfort bar:</span> p50 RTF_e2e ≤ 0.5 (≥2× real-time)</li>
              </ul>
            </div>
            
            <div class="text-xs text-gray-500 pt-2 border-t border-dark-600">
              <strong>Current:</strong> <span id="rtf-tooltip-current" class="text-white">0.45</span> 
              (<span id="rtf-speedup" class="text-green-400">2.2× real-time</span>)
            </div>
          </div>
          
          <!-- Tooltip arrow -->
          <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-dark-800"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Overview -->
  <div class="bg-dark-700 rounded-2xl p-6 border border-dark-600 mb-6">
    <h3 class="text-lg font-semibold text-white mb-4">Results Overview</h3>
    <div class="grid grid-cols-3 gap-4">
      <div class="text-center">
        <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center mx-auto mb-2">
          <i class="fa-solid fa-file-text text-purple-400 text-lg"></i>
        </div>
        <p class="text-2xl font-bold text-white" id="total-segments">12</p>
        <p class="text-xs text-gray-400">Segments</p>
      </div>
      <div class="text-center">
        <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center mx-auto mb-2">
          <i class="fa-solid fa-clock text-blue-400 text-lg"></i>
        </div>
        <p class="text-2xl font-bold text-white" id="avg-confidence">94.7%</p>
        <p class="text-xs text-gray-400">Confidence</p>
      </div>
      <div class="text-center">
        <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center mx-auto mb-2">
          <i class="fa-solid fa-check-circle text-green-400 text-lg"></i>
        </div>
        <p class="text-2xl font-bold text-white" id="files-processed">3</p>
        <p class="text-xs text-gray-400">Files</p>
      </div>
    </div>
  </div>

  <!-- Transcript Display -->
  <div class="bg-dark-700 rounded-2xl p-6 border border-dark-600 mb-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-white">Transcript</h3>
      <div class="flex items-center space-x-2">
        <button id="table-view-btn" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition-colors">
          <i class="fa-solid fa-table mr-2"></i>Table View
        </button>
        <button id="copy-transcript-btn" class="px-3 py-2 bg-dark-600 hover:bg-dark-600/80 rounded-lg text-sm transition-colors">
          <i class="fa-solid fa-copy mr-2"></i>Copy
        </button>
      </div>
    </div>
    
    <div id="transcript-content" class="space-y-3 max-h-64 overflow-y-auto">
      <!-- Sample transcript segments -->
      <div class="flex items-start space-x-3">
        <div class="w-16 text-xs text-gray-400 mt-1">00:00</div>
        <div class="flex-1">
          <p class="text-white text-sm">We launched the spring campaign with a focus on digital engagement.</p>
        </div>
      </div>
      <div class="flex items-start space-x-3">
        <div class="w-16 text-xs text-gray-400 mt-1">00:15</div>
        <div class="flex-1">
          <p class="text-white text-sm">The results exceeded our expectations across all channels.</p>
        </div>
      </div>
      <div class="flex items-start space-x-3">
        <div class="w-16 text-xs text-gray-400 mt-1">00:32</div>
        <div class="flex-1">
          <p class="text-white text-sm">Customer engagement grew by forty percent compared to last quarter.</p>
        </div>
      </div>
      <div class="flex items-start space-x-3">
        <div class="w-16 text-xs text-gray-400 mt-1">00:48</div>
        <div class="flex-1">
          <p class="text-white text-sm">Social media interactions reached an all-time high.</p>
        </div>
      </div>
      <div class="flex items-start space-x-3">
        <div class="w-16 text-xs text-gray-400 mt-1">01:05</div>
        <div class="flex-1">
          <p class="text-white text-sm">The campaign successfully increased brand awareness.</p>
        </div>
      </div>
      <div class="flex items-start space-x-3">
        <div class="w-16 text-xs text-gray-400 mt-1">01:22</div>
        <div class="flex-1">
          <p class="text-white text-sm">We're planning to expand this strategy to other markets.</p>
        </div>
      </div>
      <div class="flex items-start space-x-3">
        <div class="w-16 text-xs text-gray-400 mt-1">01:38</div>
        <div class="flex-1">
          <p class="text-white text-sm">The team is excited about the future opportunities.</p>
        </div>
      </div>
      <div class="flex items-start space-x-3">
        <div class="w-16 text-xs text-gray-400 mt-1">01:55</div>
        <div class="flex-1">
          <p class="text-white text-sm">Thank you for watching our campaign overview.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Options -->
  <div class="bg-dark-700 rounded-2xl p-6 border border-dark-600 mb-6">
    <h3 class="text-lg font-semibold text-white mb-4">Export Results</h3>
    <div class="grid grid-cols-2 gap-3">
      <button id="export-json-btn" class="bg-dark-600 hover:bg-dark-600/80 rounded-xl p-4 border border-dark-500 flex items-center justify-center space-x-3 transition-colors">
        <i class="fa-solid fa-file-code text-purple-400 text-lg"></i>
        <span class="text-white font-medium">JSON</span>
      </button>
      
      <button id="export-srt-btn" class="bg-dark-600 hover:bg-dark-600/80 rounded-xl p-4 border border-dark-500 flex items-center justify-center space-x-3 transition-colors">
        <i class="fa-solid fa-closed-captioning text-blue-400 text-lg"></i>
        <span class="text-white font-medium">SRT</span>
      </button>
      
      <button id="export-txt-btn" class="bg-dark-600 hover:bg-dark-600/80 rounded-xl p-4 border border-dark-500 flex items-center justify-center space-x-3 transition-colors">
        <i class="fa-solid fa-file-lines text-green-400 text-lg"></i>
        <span class="text-white font-medium">TXT</span>
      </button>
      
      <button id="export-all-btn" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 rounded-xl p-4 border border-dark-500 flex items-center justify-center space-x-3 transition-colors">
        <i class="fa-solid fa-download text-white text-lg"></i>
        <span class="text-white font-medium">All</span>
      </button>
    </div>
  </div>

  <!-- Xiaomi Resource Stats -->
  <div class="bg-dark-700 rounded-2xl p-6 border border-dark-600 mb-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-white">Xiaomi Resource Usage</h3>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
        <span class="text-sm text-blue-400 font-medium">Live</span>
      </div>
    </div>
    
    <!-- Resource Stats Grid -->
    <div class="grid grid-cols-2 gap-4 mb-4">
      <div class="bg-dark-600 rounded-xl p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center space-x-2">
            <i class="fa-solid fa-memory text-orange-400"></i>
            <span class="text-sm text-gray-300">Memory</span>
          </div>
          <span class="text-lg font-bold text-white" id="resource-memory">0%</span>
        </div>
        <div class="w-full bg-dark-500 rounded-full h-2">
          <div class="bg-gradient-to-r from-orange-500 to-red-500 h-2 rounded-full transition-all duration-300" id="memory-bar" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="bg-dark-600 rounded-xl p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center space-x-2">
            <i class="fa-solid fa-microchip text-blue-400"></i>
            <span class="text-sm text-gray-300">CPU</span>
          </div>
          <span class="text-lg font-bold text-white" id="resource-cpu">0%</span>
        </div>
        <div class="w-full bg-dark-500 rounded-full h-2">
          <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-300" id="cpu-bar" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="bg-dark-600 rounded-xl p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center space-x-2">
            <i class="fa-solid fa-battery-half text-green-400"></i>
            <span class="text-sm text-gray-300">Battery</span>
          </div>
          <span class="text-lg font-bold text-white" id="resource-battery">0%</span>
        </div>
        <div class="w-full bg-dark-500 rounded-full h-2">
          <div class="bg-gradient-to-r from-green-500 to-yellow-500 h-2 rounded-full transition-all duration-300" id="battery-bar" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="bg-dark-600 rounded-xl p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center space-x-2">
            <i class="fa-solid fa-thermometer-half text-red-400"></i>
            <span class="text-sm text-gray-300">Temperature</span>
          </div>
          <span class="text-lg font-bold text-white" id="resource-temperature">0°C</span>
        </div>
        <div class="text-xs text-gray-400 mt-1" id="temperature-status">Normal</div>
      </div>
    </div>
    
    <!-- Detailed Stats -->
    <div class="bg-dark-600 rounded-xl p-4">
      <h4 class="text-sm font-semibold text-gray-300 mb-3">System Details</h4>
      <div class="space-y-2 text-xs">
        <div class="flex justify-between">
          <span class="text-gray-400">Battery Details:</span>
          <span class="text-white" id="battery-details">Loading...</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-400">GPU Info:</span>
          <span class="text-white" id="gpu-info">Loading...</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-400">Thread Info:</span>
          <span class="text-white" id="thread-info">Loading...</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-400">Last Update:</span>
          <span class="text-white" id="last-update">Never</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="bg-dark-700 rounded-2xl p-6 border border-dark-600 mb-6">
    <h3 class="text-lg font-semibold text-white mb-4">Quick Actions</h3>
    <div class="space-y-3">
      <button id="new-analysis-btn" class="w-full bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-semibold py-4 px-6 rounded-xl flex items-center justify-center space-x-3 transition-all duration-200">
        <i class="fa-solid fa-plus text-xl"></i>
        <span class="text-lg">New Analysis</span>
      </button>
      
      <button id="go-back-btn" class="w-full bg-dark-600 hover:bg-dark-600/80 text-gray-200 font-medium py-3 px-6 rounded-xl flex items-center justify-center space-x-3 transition-all duration-200">
        <i class="fa-solid fa-arrow-left text-lg"></i>
        <span>Go Back</span>
      </button>
    </div>
  </div>
</div>

<!-- Bottom Navigation -->
<div id="bottom-navigation" class="fixed bottom-0 left-0 right-0 bg-dark-800 border-t border-dark-600 px-6 py-3 pb-[env(safe-area-inset-bottom)]">
  <div class="flex items-center justify-between">
    <div class="flex items-center space-x-6">
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
        <span class="text-xs text-green-400 font-medium">Select</span>
      </div>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
        <span class="text-xs text-green-400 font-medium">Processing</span>
      </div>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
        <span class="text-xs text-green-400 font-medium">Results</span>
      </div>
    </div>
    <div class="text-xs text-gray-500">Whisper Results</div>
  </div>
</div>

<script>
/* ===================== WHISPER: RESULTS & EXPORT ===================== */

(() => {
  // State management
  const state = {
    batchId: 'batch_12345',
    totalDuration: '2:34',
    processingTime: '7.2s',
    rtf: 0.45,
    totalSegments: 12,
    avgConfidence: 94.7,
    filesProcessed: 3
  };

  // Sample transcript data
  const transcriptData = {
    segments: [
      { start: '00:00', text: 'We launched the spring campaign with a focus on digital engagement.' },
      { start: '00:15', text: 'The results exceeded our expectations across all channels.' },
      { start: '00:32', text: 'Customer engagement grew by forty percent compared to last quarter.' },
      { start: '00:48', text: 'Social media interactions reached an all-time high.' },
      { start: '01:05', text: 'The campaign successfully increased brand awareness.' },
      { start: '01:22', text: 'We\'re planning to expand this strategy to other markets.' },
      { start: '01:38', text: 'The team is excited about the future opportunities.' },
      { start: '01:55', text: 'Thank you for watching our campaign overview.' }
    ],
    metadata: {
      batchId: state.batchId,
      totalDuration: state.totalDuration,
      processingTime: state.processingTime,
      rtf: state.rtf,
      totalSegments: state.totalSegments,
      avgConfidence: state.avgConfidence,
      filesProcessed: state.filesProcessed,
      language: 'English',
      createdAt: new Date().toISOString()
    }
  };

  // Bridge contract (if running in Android WebView)
  const hasBridge = typeof window.WhisperBridge !== 'undefined';
  const bridge = hasBridge ? {
    async exportJson(jobId) { return window.WhisperBridge.exportJson(jobId); },
    async exportSrt(jobId) { return window.WhisperBridge.exportSrt(jobId); },
    async exportTxt(jobId) { return window.WhisperBridge.exportTxt(jobId); },
    async exportAll(jobId) { return window.WhisperBridge.exportAll(jobId); },
    async goBack() { return window.WhisperBridge.goBack(); },
    async newAnalysis() { return window.WhisperBridge.newAnalysis(); },
    async getResourceStats() { return window.WhisperBridge.getResourceStats(); },
    async getLatestSidecar() { return window.WhisperBridge.getLatestSidecar(); },
    async getLatestTranscript() { return window.WhisperBridge.getLatestTranscript(); }
  } : {
    // Mock bridge for browser testing
    async exportJson(jobId) { 
      console.log('Mock: Exporting JSON for job:', jobId);
      return 'ok';
    },
    async exportSrt(jobId) { 
      console.log('Mock: Exporting SRT for job:', jobId);
      return 'ok';
    },
    async exportTxt(jobId) { 
      console.log('Mock: Exporting TXT for job:', jobId);
      return 'ok';
    },
    async exportAll(jobId) { 
      console.log('Mock: Exporting all formats for job:', jobId);
      return 'ok';
    },
    async goBack() { 
      console.log('Mock: Going back to previous step');
      return 'ok';
    },
    async newAnalysis() { 
      console.log('Mock: Starting new analysis');
      return 'ok';
    },
    async getResourceStats() { 
      return JSON.stringify({
        memory: Math.floor(Math.random() * 50) + 20,
        cpu: Math.floor(Math.random() * 30) + 10,
        battery: Math.floor(Math.random() * 40) + 60,
        temperature: Math.floor(Math.random() * 10) + 35,
        batteryDetails: 'Level: 75%, Temp: 37.2°C, Voltage: 4.1V',
        gpuInfo: 'GPU: Adreno 640',
        threadInfo: 'Threads: 45 | Main: main | Active: 12 | CPUs: 8 | Est. Processing: 16',
        timestamp: Date.now()
      });
    },
    async getLatestSidecar() {
      return JSON.stringify({
        job_id: state.batchId,
        uri: 'file:///sdcard/video1.mp4',
        preset: 'Single',
        rtf: state.rtf,
        created_at: Date.now()
      });
    },
    async getLatestTranscript() {
      return transcriptData.segments.map(segment => `${segment.start} - ${segment.text}`).join('\n');
    }
  };

  // DOM Elements
  const backBtn = document.getElementById('back-btn');
  const copyTranscriptBtn = document.getElementById('copy-transcript-btn');
  const exportJsonBtn = document.getElementById('export-json-btn');
  const exportSrtBtn = document.getElementById('export-srt-btn');
  const exportTxtBtn = document.getElementById('export-txt-btn');
  const exportAllBtn = document.getElementById('export-all-btn');
  const newAnalysisBtn = document.getElementById('new-analysis-btn');
  const goBackBtn = document.getElementById('go-back-btn');
  const rtfValue = document.getElementById('rtf-value');

  // Utility functions
  function showToast(message, isError = false) {
    console.log(isError ? 'ERROR:' : 'SUCCESS:', message);
    // In a real app, you'd show a toast notification
  }

  // RTF utility functions
  function calculateSpeedup(rtf) {
    return rtf > 0 ? (1 / rtf).toFixed(1) : 'N/A';
  }

  function updateRTFTooltip(rtfValue) {
    const rtfTooltipCurrent = document.getElementById('rtf-tooltip-current');
    const rtfSpeedup = document.getElementById('rtf-speedup');
    
    if (rtfTooltipCurrent && rtfSpeedup) {
      rtfTooltipCurrent.textContent = rtfValue.toFixed(2);
      const speedup = calculateSpeedup(rtfValue);
      rtfSpeedup.textContent = `${speedup}× real-time`;
      
      // Update color based on performance
      if (rtfValue < 0.5) {
        rtfSpeedup.className = 'text-green-400';
      } else if (rtfValue < 1.0) {
        rtfSpeedup.className = 'text-yellow-400';
      } else {
        rtfSpeedup.className = 'text-red-400';
      }
    }
  }

  // RTF tooltip functionality
  function toggleRTFTooltip() {
    const tooltip = document.getElementById('rtf-tooltip');
    if (tooltip) {
      const isVisible = !tooltip.classList.contains('invisible');
      
      if (isVisible) {
        // Hide tooltip
        tooltip.classList.add('opacity-0', 'invisible');
      } else {
        // Show tooltip
        tooltip.classList.remove('opacity-0', 'invisible');
      }
    }
  }

  function hideRTFTooltip() {
    const tooltip = document.getElementById('rtf-tooltip');
    if (tooltip) {
      tooltip.classList.add('opacity-0', 'invisible');
    }
  }

  function copyToClipboard(text) {
    if (navigator.clipboard) {
      navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard');
      }).catch(() => {
        showToast('Failed to copy', true);
      });
    } else {
      // Fallback for older browsers
      const textArea = document.createElement('textarea');
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        showToast('Copied to clipboard');
      } catch (err) {
        showToast('Failed to copy', true);
      }
      document.body.removeChild(textArea);
    }
  }

  // Event handlers
  backBtn.onclick = async () => {
    try {
      await bridge.goBack();
    } catch (e) {
      console.error('Error going back:', e);
      showToast('Failed to go back', true);
    }
  };

  copyTranscriptBtn.onclick = () => {
    const transcriptText = transcriptData.segments
      .map(segment => `${segment.start} - ${segment.text}`)
      .join('\n');
    copyToClipboard(transcriptText);
  };

  exportJsonBtn.onclick = async () => {
    try {
      await bridge.exportJson(state.batchId);
      showToast('JSON export completed');
    } catch (e) {
      console.error('Error exporting JSON:', e);
      showToast('Failed to export JSON', true);
    }
  };

  exportSrtBtn.onclick = async () => {
    try {
      await bridge.exportSrt(state.batchId);
      showToast('SRT export completed');
    } catch (e) {
      console.error('Error exporting SRT:', e);
      showToast('Failed to export SRT', true);
    }
  };

  exportTxtBtn.onclick = async () => {
    try {
      await bridge.exportTxt(state.batchId);
      showToast('TXT export completed');
    } catch (e) {
      console.error('Error exporting TXT:', e);
      showToast('Failed to export TXT', true);
    }
  };

  // Table view button
  const tableViewBtn = document.getElementById('table-view-btn');
  tableViewBtn.onclick = () => {
    try {
      if (hasBridge && window.WhisperBridge.openWhisperBatchResults) {
        window.WhisperBridge.openWhisperBatchResults(state.batchId);
      } else {
        // Fallback: open in new tab/window
        const url = `whisper_batch_results.html?batchId=${state.batchId}`;
        window.open(url, '_blank');
      }
    } catch (e) {
      console.error('Error opening table view:', e);
    }
  };

  exportAllBtn.onclick = async () => {
    try {
      await bridge.exportAll(state.batchId);
      showToast('All formats exported successfully');
    } catch (e) {
      console.error('Error exporting all:', e);
      showToast('Failed to export all formats', true);
    }
  };

  newAnalysisBtn.onclick = async () => {
    try {
      await bridge.newAnalysis();
    } catch (e) {
      console.error('Error starting new analysis:', e);
      showToast('Failed to start new analysis', true);
    }
  };

  goBackBtn.onclick = async () => {
    try {
      await bridge.goBack();
    } catch (e) {
      console.error('Error going back:', e);
      showToast('Failed to go back', true);
    }
  };

  // RTF tooltip event handlers
  if (rtfValue) {
    rtfValue.onclick = (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleRTFTooltip();
    };

    rtfValue.ontouchstart = (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleRTFTooltip();
    };
  }

  // Hide tooltip when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('#rtf-value') && !e.target.closest('#rtf-tooltip')) {
      hideRTFTooltip();
    }
  });

  // Resource monitoring functions
  function updateResourceStats(statsJson) {
    try {
      const stats = JSON.parse(statsJson);
      
      // Update main resource displays
      document.getElementById('resource-memory').textContent = stats.memory + '%';
      document.getElementById('resource-cpu').textContent = stats.cpu.toFixed(1) + '%';
      document.getElementById('resource-battery').textContent = stats.battery + '%';
      document.getElementById('resource-temperature').textContent = stats.temperature.toFixed(1) + '°C';
      
      // Update progress bars
      document.getElementById('memory-bar').style.width = stats.memory + '%';
      document.getElementById('cpu-bar').style.width = stats.cpu + '%';
      document.getElementById('battery-bar').style.width = stats.battery + '%';
      
      // Update detailed information
      document.getElementById('battery-details').textContent = stats.batteryDetails || 'N/A';
      document.getElementById('gpu-info').textContent = stats.gpuInfo || 'N/A';
      document.getElementById('thread-info').textContent = stats.threadInfo || 'N/A';
      
      // Update timestamp
      const updateTime = new Date(stats.timestamp).toLocaleTimeString();
      document.getElementById('last-update').textContent = updateTime;
      
      // Update temperature status
      const tempStatus = document.getElementById('temperature-status');
      if (stats.temperature > 40) {
        tempStatus.textContent = 'Hot';
        tempStatus.className = 'text-xs text-red-400 mt-1';
      } else if (stats.temperature < 30) {
        tempStatus.textContent = 'Cool';
        tempStatus.className = 'text-xs text-blue-400 mt-1';
      } else {
        tempStatus.textContent = 'Normal';
        tempStatus.className = 'text-xs text-green-400 mt-1';
      }
      
      // Update global resource monitor if available
      if (window.updateGlobalResourceStats) {
        window.updateGlobalResourceStats(statsJson);
      }
      
      console.log('Resource stats updated:', stats);
    } catch (e) {
      console.error('Error parsing resource stats:', e);
    }
  }
  
  // Connector service event handlers
  function handleProcessingStart(batchId, fileCount) {
    console.log('Processing started:', batchId, 'with', fileCount, 'files');
    
    // Update UI with real batch data
    state.batchId = batchId;
    state.filesProcessed = fileCount;
    
    // Update display
    document.getElementById('batch-id').textContent = batchId;
    document.getElementById('files-processed').textContent = fileCount;
    
    showToast(`Processing started: ${batchId}`);
  }
  
  function handleProgressUpdate(batchId, progress, fileCount, currentFile) {
    console.log('Progress update:', batchId, progress + '%', `file ${currentFile}/${fileCount}`);
    
    // Update processing stats if still processing
    if (progress < 100) {
      document.getElementById('processing-time').textContent = 'Processing...';
      document.getElementById('rtf-value').textContent = 'Calculating...';
    }
    
    showToast(`Progress: ${progress}% (file ${currentFile + 1}/${fileCount})`);
  }
  
  function handleProcessingComplete(batchId) {
    console.log('Processing complete:', batchId);
    
    // Update completion status
    document.getElementById('processing-time').textContent = 'Complete';
    document.getElementById('rtf-value').textContent = state.rtf.toFixed(2);
    updateRTFTooltip(state.rtf);
    
    showToast('Processing complete!');
    
    // Load latest results
    loadResultsData();
  }
  
  // Make functions globally available for connector service
  window.updateResourceStats = updateResourceStats;
  window.handleProcessingStart = handleProcessingStart;
  window.handleProgressUpdate = handleProgressUpdate;
  window.handleProcessingComplete = handleProcessingComplete;
  
  // Initialize resource monitoring
  async function initializeResourceMonitoring() {
    try {
      const stats = await bridge.getResourceStats();
      updateResourceStats(stats);
    } catch (e) {
      console.error('Error initializing resource monitoring:', e);
    }
  }

  // Load real data from bridge
  async function loadResultsData() {
    try {
      if (hasBridge) {
        // Load sidecar data
        const sidecar = await bridge.getLatestSidecar();
        const sidecarData = JSON.parse(sidecar);
        
        if (sidecarData.job_id) {
          document.getElementById('batch-id').textContent = sidecarData.job_id;
          state.batchId = sidecarData.job_id;
        }
        
        if (sidecarData.rtf) {
          document.getElementById('rtf-value').textContent = sidecarData.rtf.toFixed(2);
          state.rtf = sidecarData.rtf;
          updateRTFTooltip(sidecarData.rtf);
        }
        
        // Load transcript data
        const transcript = await bridge.getLatestTranscript();
        if (transcript) {
          // Update transcript display with real data
          const transcriptContent = document.getElementById('transcript-content');
          transcriptContent.innerHTML = '';
          
          const lines = transcript.split('\n');
          lines.forEach(line => {
            if (line.trim()) {
              const [time, ...textParts] = line.split(' - ');
              const text = textParts.join(' - ');
              
              const segmentDiv = document.createElement('div');
              segmentDiv.className = 'flex items-start space-x-3';
              segmentDiv.innerHTML = `
                <div class="w-16 text-xs text-gray-400 mt-1">${time || '00:00'}</div>
                <div class="flex-1">
                  <p class="text-white text-sm">${text}</p>
                </div>
              `;
              transcriptContent.appendChild(segmentDiv);
            }
          });
        }
      }
    } catch (e) {
      console.error('Error loading results data:', e);
    }
  }

  // Initialize global resource monitor
  async function initializeGlobalResourceMonitor() {
    try {
      // Load the global resource monitor component
      const monitorResponse = await fetch('global_resource_monitor.html');
      if (monitorResponse.ok) {
        const monitorHtml = await monitorResponse.text();
        const monitorContainer = document.createElement('div');
        monitorContainer.innerHTML = monitorHtml;
        document.body.appendChild(monitorContainer);
        
        // Initialize the global monitor
        if (window.initializeGlobalResourceMonitor) {
          window.initializeGlobalResourceMonitor();
        }
        console.log('Global resource monitor initialized');
      }
    } catch (e) {
      console.error('Error initializing global resource monitor:', e);
    }
  }

  // Initialize
  console.log('Whisper Results initialized');
  showToast('Results loaded successfully');
  initializeGlobalResourceMonitor();
  
  // Load real data
  loadResultsData();
  
  // Start resource monitoring
  initializeResourceMonitoring();
  
  // Auto-refresh resource stats
  if (hasBridge) {
    setInterval(initializeResourceMonitoring, 3000);
  }

})();
</script>

</body>
</html>